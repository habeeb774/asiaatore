import{r as i,j as e}from"./vendor.react-BIXKTxlu.js";import{R as Oe}from"./reactLeafletCompat-CJfjRSDT.js";import{i as Re,c as Ae,a as De,b as _e}from"./paymentService-CJCDmSv0.js";import{d as qe,e as Te,a as He,u as Be,f as Le,g as w,l as Ve}from"./index-B9WgXUd4.js";import"./vendor-CKneRQof.js";import"./vendor.router-BdFOcp8q.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.tanstack-K6OTystZ.js";import"./vendor.leaflet-Dl6I9sMh.js";/* empty css                     */const as=()=>{const{cartItems:v,clearCart:Z}=qe()||{},{user:N}=Te()||{},{setting:ee}=He()||{},ge=Be()?.locale??"ar",[o,u]=i.useState({address:!0,payment:!1,review:!1,realpay:!1,complete:!1}),se=s=>u(t=>({...t,[s]:!t[s]})),te="my_store_checkout_address",L=()=>{try{const s=localStorage.getItem(te);if(s)return JSON.parse(s)}catch{}return{name:N?.name||"",email:N?.email||"",country:"SA",city:"",line1:"",phone:"",geo:null}},[r,f]=i.useState(L),[k,V]=i.useState(()=>L()?.geo||null),[ae,G]=i.useState(!1),[ne,C]=i.useState(""),[re,be]=i.useState([]),[je,ie]=i.useState(""),[l,K]=i.useState({}),[d,g]=i.useState({}),le="my_store_last_coupon",[$,ve]=i.useState(()=>{try{return localStorage.getItem(le)||""}catch{return""}}),[x,O]=i.useState(null),[S,M]=i.useState(0),[m,R]=i.useState(null),[ce,oe]=i.useState(!1),[A,Ne]=i.useState(null),[de,me]=i.useState(null),[h,U]=i.useState("cod"),z=i.useMemo(()=>{const s=ee||{};return{cod:s.payCodEnabled!==!1,bank:s.payBankEnabled!==!1,stc:!!s.payStcEnabled,paypal:!!s.payPaypalEnabled}},[ee]),E=i.useMemo(()=>["cod","paypal","stc","bank"].filter(s=>z[s]),[z]);i.useEffect(()=>{!E.includes(h)&&E.length&&U(E[0])},[E,h]);const[D,_]=i.useState(!1),[ue,y]=i.useState(""),[I,we]=i.useState(null),[J,pe]=i.useState(null),{refresh:Ke}=Le()||{},b=i.useMemo(()=>(v||[]).reduce((s,t)=>s+(t.price||0)*(t.quantity||1),0),[v]);i.useEffect(()=>{(async()=>{const t=(r.city||"").trim();if(!t){M(0),R(null);return}try{const a=await w.shippingQuote({city:t,country:r.country,geo:r?.geo||null});a?.ok?(M(Number(a.shipping)||0),R({method:a.method,distanceKm:a.distanceKm,cityMatched:a.cityMatched,etaHoursMin:a.etaHoursMin,etaHoursMax:a.etaHoursMax,etaDaysMin:a.etaDaysMin,etaDaysMax:a.etaDaysMax})):(M(25),R(null))}catch{M(25),R(null)}})()},[r.city,r.country,r?.geo?.lat,r?.geo?.lng]),i.useEffect(()=>{try{localStorage.setItem(te,JSON.stringify(r))}catch{}},[r]),i.useEffect(()=>{let s=!0;return(async()=>{if(N)try{const t=await w.addressesList(),a=t.addresses||t.items||[];if(!s)return;be(a);const n=a.find(c=>c.isDefault)||a[0];n&&(ie(n.id),f(c=>({...c,name:n.name||c.name,email:c.email,country:n.country||c.country,city:n.city||c.city,line1:n.street||c.line1,phone:n.phone||c.phone})))}catch{}})(),()=>{s=!1}},[N?.id]);const q=x?.amount||0,he=Math.max(0,b-q),T=+(he*.15).toFixed(2),xe=+(he+T+(S||0)).toFixed(2),j=(s,t)=>{const a=(t??"").toString();switch(s){case"name":return a.trim()?"":"الاسم مطلوب";case"email":return a.includes("@")&&/.+@.+\..+/.test(a)?"":"بريد غير صالح";case"city":return a.trim()?"":"المدينة مطلوبة";case"line1":return a.trim()?"":"العنوان مطلوب";case"phone":return a.trim()?"":"الهاتف مطلوب";default:return""}},H=()=>{const s={name:j("name",r.name),email:j("email",r.email),city:j("city",r.city),line1:j("line1",r.line1),phone:j("phone",r.phone)};return Object.keys(s).forEach(t=>{s[t]||delete s[t]}),K(s),g(t=>({...t,name:!0,email:!0,city:!0,line1:!0,phone:!0})),Object.keys(s).length===0},Y=()=>{try{const s=["name","email","city","line1","phone"],t=s.find(c=>!!l[c])||s.find(c=>j(c,r[c]));if(!t)return;const a=`shipping-${t==="line1"?"address":t}`,n=document.getElementById(a);if(n&&typeof n.focus=="function"){n.focus(),n.scrollIntoView({behavior:"smooth",block:"center"});try{n.classList.add("field-flash"),setTimeout(()=>n.classList.remove("field-flash"),900)}catch{}}}catch{}},P=s=>t=>{const a=t?.target?.value??"";f(c=>({...c,[s]:a})),g(c=>({...c,[s]:!0}));const n=j(s,a);K(c=>{const p={...c};return n?p[s]=n:delete p[s],p})},ke=()=>{H()&&u(s=>({...s,address:!1,payment:!0}))},Ce=()=>{if(!$.trim())return;const s=$.trim().toUpperCase();s==="SAVE10"?O({code:s,amount:Math.min(10,b*.2)}):s==="FREESHIP"?(O({code:s,amount:0}),M(0)):O(s==="SAVE20"?{code:s,amount:Math.min(20,b*.3)}:null);try{localStorage.setItem(le,s)}catch{}},ye=()=>({userId:N?.id||"guest",items:(v||[]).map(s=>({productId:typeof s.id=="string"&&!s.id.startsWith("p_")&&s.id.length>10&&typeof s.id=="string"?s.id:"custom",name:{ar:s.name?.ar||s.name||"صنف",en:s.name?.en||s.name||"Item"},price:typeof s.price=="number"?s.price:Number(s.price||0),quantity:Number.isFinite(Number(s.quantity))?Number(s.quantity):1,oldPrice:typeof s.oldPrice=="number"?s.oldPrice:s.oldPrice?Number(s.oldPrice):null})),currency:"SAR",paymentMethod:h,paymentMeta:{address:r,coupon:x?.code||null,shipping:S},discount:q,tax:T}),F=async(s=!1)=>{me(null);const t=ye();if(A&&!s)try{return await w.updateOrder(A,{items:t.items,paymentMethod:t.paymentMethod,paymentMeta:t.paymentMeta}),A}catch{}oe(!0);try{const a=await w.createOrder(t);if(!a?.order?.id)throw new Error("Create failed");return Ne(a.order.id),a.order.id}catch(a){try{console.error("[ORDER_CREATE_ERROR]",a),a?.data&&console.error("[ORDER_CREATE_ERROR].data",a.data)}catch{}throw me("تعذر إنشاء الطلب حالياً. الرجاء المحاولة مرة أخرى."),a}finally{oe(!1)}},Se=async()=>{if(!H()){Y();return}try{await F(),u(s=>({...s,address:!1,payment:!1,review:!0}))}catch{Y()}},Me=async()=>{if(!H()){u(s=>({...s,address:!0,payment:!1,review:!1,realpay:!1})),Y();return}try{await F(),u(s=>({...s,realpay:!0}))}catch{}},Q=()=>{Z&&Z(),u({address:!1,payment:!1,review:!1,realpay:!1,complete:!0})},Ee=!v?.length&&!o.complete,Ie=i.useMemo(()=>({_placeholder:!0}),[]),W=async(s,t)=>{C("");try{const a=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(s)}&lon=${encodeURIComponent(t)}&zoom=16&addressdetails=1`,n=await fetch(a,{headers:{Accept:"application/json"}});if(!n.ok)throw new Error("GEOCODE_FAILED");const c=await n.json(),p=c.address||{},Fe=p.city||p.town||p.village||p.county||p.state||"",$e=p.road||p.neighbourhood||p.suburb||p.hamlet||p.quarter||c.display_name||"";f(X=>({...X,city:Fe||X.city,line1:$e||X.line1,geo:{lat:s,lng:t}}))}catch{f(n=>({...n,geo:{lat:s,lng:t}})),C("تعذر تحديد العنوان تلقائياً. يمكنك إدخال المدينة والعنوان يدوياً.")}},Pe=()=>{if(!("geolocation"in navigator)){C("المتصفح لا يدعم GPS");return}G(!0),C("جارِ تحديد موقعك..."),navigator.geolocation.getCurrentPosition(s=>{const{latitude:t,longitude:a}=s.coords;V({lat:t,lng:a}),W(t,a).finally(()=>G(!1))},s=>{G(!1),C(s?.message?`تعذر الوصول للموقع: ${s.message}`:"تعذر الوصول للموقع")},{enableHighAccuracy:!0,maximumAge:5e3,timeout:15e3})},B=o.review||o.payment||o.realpay||o.complete?2:o.address?1:0,fe=Math.round((B+1)/3*100);return e.jsxs("div",{className:"container-custom px-4 py-12 checkout-page-enhanced",children:[Ee&&e.jsx("div",{className:"mb-6",children:e.jsx("h2",{className:"text-xl font-bold",children:"السلة فارغة"})}),e.jsxs("div",{className:"checkout-progress mobile-gutters",role:"progressbar","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":fe,children:[e.jsx("div",{className:"checkout-progress__bar",children:e.jsx("span",{style:{width:`${fe}%`}})}),e.jsxs("div",{className:"checkout-progress__labels",children:[e.jsx("span",{className:B>=0?"is-active":"",children:"السلة"}),e.jsx("span",{className:B>=1?"is-active":"",children:"العنوان"}),e.jsx("span",{className:B>=2?"is-active":"",children:"الدفع"})]})]}),e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"الدفع (Checkout)"}),e.jsxs("ol",{className:"flex items-center gap-3 text-xs text-gray-600 mb-4",children:[e.jsx("li",{className:`px-2 py-1 rounded ${o.address?"bg-green-100 text-green-800":"bg-gray-100"}`,children:"1. العنوان"}),e.jsx("li",{className:`px-2 py-1 rounded ${o.payment?"bg-green-100 text-green-800":"bg-gray-100"}`,children:"2. الشحن والدفع"}),e.jsx("li",{className:`px-2 py-1 rounded ${o.review?"bg-green-100 text-green-800":"bg-gray-100"}`,children:"3. المراجعة"}),e.jsx("li",{className:`px-2 py-1 rounded ${o.realpay?"bg-green-100 text-green-800":"bg-gray-100"}`,children:"4. الدفع"})]}),e.jsxs("div",{className:"mb-4 border rounded overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:()=>se("address"),className:"w-full flex justify-between items-center px-4 py-3 bg-gray-50 text-sm font-semibold",children:[e.jsx("span",{children:"العنوان"}),e.jsx("span",{children:o.address?"−":"+"})]}),o.address&&e.jsxs("div",{className:"grid gap-4 max-w-xl p-4",children:[N&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-semibold",children:"اختر عنوان محفوظ"}),e.jsxs("select",{className:"border px-3 py-2",value:je,onChange:s=>{const t=s.target.value;ie(t);const a=re.find(n=>n.id===t);a&&f(n=>({...n,name:a.name||n.name,country:a.country||n.country,city:a.city||n.city,line1:a.street||n.line1,phone:a.phone||n.phone}))},children:[e.jsx("option",{value:"",children:"— بدون —"}),re.map(s=>e.jsxs("option",{value:s.id,children:[s.label||s.city||s.street," ",s.isDefault?"• افتراضي":""]},s.id))]}),e.jsxs("div",{className:"text-xs",children:["لإدارة العناوين: ",e.jsx("a",{href:"/account/addresses",className:"text-primary-red",children:"عناويني"})]})]}),e.jsx("input",{id:"shipping-name",name:"name",autoComplete:"name",className:`border px-3 py-2 ${d.name&&l.name?"is-invalid":""}`,placeholder:"الاسم",value:r.name,onChange:P("name"),onBlur:()=>g(s=>({...s,name:!0})),"aria-invalid":!!(d.name&&l.name),"aria-describedby":d.name&&l.name?"err-name":void 0}),d.name&&l.name&&e.jsx("div",{id:"err-name",className:"field-hint",children:l.name}),e.jsx("input",{id:"shipping-email",name:"email",type:"email",autoComplete:"email",className:`border px-3 py-2 ${d.email&&l.email?"is-invalid":""}`,placeholder:"البريد",value:r.email,onChange:P("email"),onBlur:()=>g(s=>({...s,email:!0})),"aria-invalid":!!(d.email&&l.email),"aria-describedby":d.email&&l.email?"err-email":void 0}),d.email&&l.email&&e.jsx("div",{id:"err-email",className:"field-hint",children:l.email}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("input",{id:"shipping-country",name:"country",autoComplete:"country-name",className:"border px-3 py-2",placeholder:"الدولة",value:r.country,onChange:s=>f(t=>({...t,country:s.target.value}))}),e.jsx("input",{id:"shipping-city",name:"city",autoComplete:"address-level2",className:`border px-3 py-2 ${d.city&&l.city?"is-invalid":""}`,placeholder:"المدينة",value:r.city,onChange:P("city"),onBlur:()=>g(s=>({...s,city:!0})),"aria-invalid":!!(d.city&&l.city),"aria-describedby":d.city&&l.city?"err-city":void 0})]}),d.city&&l.city&&e.jsx("div",{id:"err-city",className:"field-hint",children:l.city}),e.jsx("input",{id:"shipping-address",name:"address1",autoComplete:"address-line1",className:`border px-3 py-2 ${d.line1&&l.line1?"is-invalid":""}`,placeholder:"العنوان",value:r.line1,onChange:P("line1"),onBlur:()=>g(s=>({...s,line1:!0})),"aria-invalid":!!(d.line1&&l.line1),"aria-describedby":d.line1&&l.line1?"err-line1":void 0}),d.line1&&l.line1&&e.jsx("div",{id:"err-line1",className:"field-hint",children:l.line1}),e.jsx("input",{id:"shipping-phone",name:"tel",type:"tel",autoComplete:"tel",className:`border px-3 py-2 ${d.phone&&l.phone?"is-invalid":""}`,placeholder:"الهاتف",value:r.phone,onChange:P("phone"),onBlur:()=>g(s=>({...s,phone:!0})),"aria-invalid":!!(d.phone&&l.phone),"aria-describedby":d.phone&&l.phone?"err-phone":void 0}),d.phone&&l.phone&&e.jsx("div",{id:"err-phone",className:"field-hint",children:l.phone}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:Pe,disabled:ae,children:ae?"...جارِ التحديد":"تحديد العنوان عبر GPS"}),r?.geo&&e.jsxs("span",{className:"text-xs text-gray-500",children:["(",r.geo.lat?.toFixed(5),", ",r.geo.lng?.toFixed(5),")"]})]}),ne&&e.jsx("div",{className:"text-xs text-gray-600",children:ne}),k&&e.jsxs("div",{className:"rounded border overflow-hidden",style:{height:260},children:[e.jsx(Oe,{children:s=>e.jsxs(s.MapContainer,{center:[k.lat,k.lng],zoom:15,style:{height:"100%",width:"100%"},children:[e.jsx(s.TileLayer,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),e.jsx(s.Marker,{position:[k.lat,k.lng],icon:Ie,draggable:!0,eventHandlers:{dragend:t=>{const n=t.target.getLatLng(),c={lat:n.lat,lng:n.lng};V(c),W(c.lat,c.lng)}}}),e.jsx(s.MapClicker,{onPick:t=>{V(t),W(t.lat,t.lng)}})]})}),e.jsx("div",{className:"p-2 text-xs text-gray-500",children:"يمكنك سحب العلامة أو النقر على الخريطة لاختيار نقطة التسليم."})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{className:"btn-primary flex-1",type:"button",onClick:ke,children:"حفظ و التالي"}),e.jsx("button",{className:"btn-secondary",type:"button",onClick:()=>{f(L()),K({})},children:"إعادة ضبط"})]})]})]}),e.jsxs("div",{className:"mb-4 border rounded overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:()=>se("payment"),className:"w-full flex justify-between items-center px-4 py-3 bg-gray-50 text-sm font-semibold",children:[e.jsx("span",{children:"الشحن و طريقة الدفع"}),e.jsx("span",{children:o.payment?"−":"+"})]}),o.payment&&e.jsxs("div",{className:"p-4 grid md:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"md:col-span-2 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold mb-2 text-sm",children:"طريقة الدفع"}),e.jsx("div",{className:"grid gap-2 text-sm",children:E.map(s=>e.jsxs("label",{className:`border rounded p-2 flex items-center gap-2 cursor-pointer ${h===s?"ring-2 ring-primary-red":""}`,children:[e.jsx("input",{type:"radio",name:"pm2",value:s,checked:h===s,onChange:()=>U(s)}),e.jsx("span",{children:s==="cod"?"الدفع عند الاستلام":s==="paypal"?"PayPal":s==="stc"?"STC Pay":"تحويل بنكي"})]},s))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold mb-2 text-sm",children:"قسيمة الخصم"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{id:"coupon",name:"coupon",className:"border px-3 py-2 flex-1 text-sm",placeholder:"رمز القسيمة",value:$,onChange:s=>ve(s.target.value)}),e.jsx("button",{className:"btn-secondary",type:"button",onClick:Ce,children:"تطبيق"})]}),x&&e.jsxs("div",{className:"text-xs text-green-600 mt-1",children:["تم تطبيق ",x.code," خصم: ",x.amount.toFixed(2)," ر.س"]}),!x&&$&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"لا يوجد خصم فعلي (رمز غير معروف)"})]})]}),e.jsxs("div",{className:"checkout-summary bg-white border rounded p-4 text-sm space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الإجمالي الفرعي"}),e.jsxs("span",{children:[b.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الخصم"}),e.jsxs("span",{children:[q.toFixed(2),"-"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الشحن"}),e.jsxs("span",{children:[S.toFixed(2)," ر.س"]})]}),m&&e.jsxs("div",{className:"text-xs text-gray-600 space-y-1",children:[e.jsxs("div",{children:["طريقة التسعير: ",m.method==="distance"?`حسب المسافة (~${m.distanceKm} كم)`:"افتراضي"]}),(m.etaDaysMin!=null||m.etaHoursMin!=null)&&e.jsxs("div",{children:["تقدير الوصول: ",m.etaDaysMin!=null?`${m.etaDaysMin}–${m.etaDaysMax} يوم`:`${m.etaHoursMin}–${m.etaHoursMax} ساعة`]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الضريبة"}),e.jsxs("span",{children:[T.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-bold",children:[e.jsx("span",{children:"الإجمالي"}),e.jsxs("span",{children:[xe.toFixed(2)," ر.س"]})]}),e.jsx("button",{disabled:ce,className:"btn-primary w-full",type:"button",onClick:Se,children:ce?"...جاري الإنشاء":"مراجعة الطلب"}),de&&e.jsxs("div",{className:"field-hint",children:["خطأ: ",de]})]})]})]}),o.review&&e.jsxs("div",{className:"grid md:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"md:col-span-2 space-y-4",children:[e.jsxs("div",{className:"bg-white border rounded p-4",children:[e.jsx("h3",{className:"font-bold mb-3",children:"العنوان"}),e.jsxs("div",{className:"text-sm leading-relaxed",children:[e.jsx("div",{children:r.name}),e.jsx("div",{children:r.email}),e.jsxs("div",{children:[r.country," - ",r.city]}),e.jsx("div",{children:r.line1}),e.jsx("div",{children:r.phone})]}),e.jsx("button",{className:"text-xs text-primary-red mt-2",onClick:()=>u(s=>({...s,address:!0,review:!1})),children:"تعديل"})]}),e.jsxs("div",{className:"bg-white border rounded p-4",children:[e.jsx("h3",{className:"font-bold mb-3",children:"العناصر"}),e.jsx("ul",{className:"divide-y text-sm",children:v.map(s=>e.jsxs("li",{className:"py-2 flex items-center gap-3",children:[e.jsx("span",{className:"truncate flex-1 max-w-[160px]",children:Ve(s,ge)}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"px-2 border",onClick:()=>w,children:"-"}),e.jsx("input",{value:s.quantity,readOnly:!0,className:"w-10 border text-center text-xs"}),e.jsx("button",{type:"button",className:"px-2 border",onClick:()=>w,children:"+"})]}),e.jsxs("span",{className:"text-xs whitespace-nowrap",children:[(s.price||0).toFixed(2)," × ",s.quantity," = ",((s.price||0)*(s.quantity||1)).toFixed(2)]})]},s.id))})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"checkout-summary bg-white border rounded p-4 text-sm space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الإجمالي الفرعي"}),e.jsxs("strong",{children:[b.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الخصم"}),e.jsxs("strong",{children:[q.toFixed(2),"-"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الشحن"}),e.jsxs("strong",{children:[S.toFixed(2)," ر.س"]})]}),m&&e.jsxs("div",{className:"text-xs text-gray-600 space-y-1",children:[e.jsx("div",{children:m.method==="distance"?`المسافة التقديرية: ~${m.distanceKm} كم`:"تسعير افتراضي للشحن"}),(m.etaDaysMin!=null||m.etaHoursMin!=null)&&e.jsxs("div",{children:["تقدير الوصول: ",m.etaDaysMin!=null?`${m.etaDaysMin}–${m.etaDaysMax} يوم`:`${m.etaHoursMin}–${m.etaHoursMax} ساعة`]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الضريبة"}),e.jsxs("strong",{children:[T.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-bold",children:[e.jsx("span",{children:"الإجمالي"}),e.jsxs("span",{children:[xe.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["رقم الطلب: ",A||"—"," / طريقة: ",h]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("button",{className:"btn-primary w-full",onClick:Q,children:"تأكيد وإكمال (دفع عند الاستلام)"}),e.jsx("button",{type:"button",className:"btn-secondary w-full",onClick:Me,children:"طرق دفع حقيقية"})]})]})})]}),o.realpay&&!o.complete&&e.jsxs("div",{className:"mt-10 border rounded overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-4 py-3 flex justify-between items-center text-sm font-semibold",children:[e.jsx("span",{children:"طرق الدفع الحقيقية"}),e.jsx("button",{onClick:()=>u(s=>({...s,realpay:!1})),children:"إغلاق"})]}),e.jsxs("div",{className:"p-4 space-y-6 max-w-xl",children:[e.jsx("div",{className:"grid gap-3",children:["paypal","stc","bank","cod"].filter(s=>z[s]).map(s=>e.jsxs("label",{className:`border rounded p-3 cursor-pointer flex items-center justify-between ${h===s?"ring-2 ring-primary-red":""}`,children:[e.jsxs("span",{children:[e.jsx("input",{type:"radio",name:"pm4",value:s,checked:h===s,onChange:()=>U(s),className:"mr-2"}),s==="paypal"?"PayPal":s==="stc"?"STC Pay (محاكاة)":s==="bank"?"تحويل بنكي":"الدفع عند الاستلام"]}),e.jsx("span",{className:"text-xs text-gray-500",children:s==="paypal"?"الدفع الآمن":s==="stc"?"محفظة رقمية":s==="bank"?"دفع يدوي":"رسوم محتملة"})]},s))}),e.jsx("button",{className:"btn-primary w-full",disabled:D,onClick:async()=>{if(!v?.length){y("السلة فارغة");return}try{_(!0),y("");const s=await F();switch(h){case"cod":y("سيتم الاكتفاء بالدفع عند الاستلام. يمكنك إنهاء الطلب.");break;case"paypal":{const t=ye(),a=await De({items:t.items,currency:t.currency});if(a?.approvalUrl)window.location.href=a.approvalUrl;else throw new Error("لا يوجد رابط موافقة");break}case"stc":{const t=await Ae({orderId:s});if(t?.sessionId)pe(t.sessionId),y("تم إنشاء جلسة STC Pay");else throw new Error("فشل إنشاء الجلسة");break}case"bank":{const t=await Re({orderId:s});if(t?.bank)we(t.bank),y("تم تحميل بيانات البنك");else throw new Error("لا توجد بيانات بنك");break}default:break}}catch(s){y(s?.message||"حدث خطأ أثناء بدء الدفع. الرجاء المحاولة مرة أخرى.")}finally{_(!1)}},children:D?"...جاري المعالجة":"بدء عملية الدفع"}),h==="bank"&&I&&e.jsxs("div",{className:"bg-gray-50 border p-4 rounded text-sm space-y-1",children:[e.jsxs("div",{children:["اسم الحساب: ",I.accountName]}),e.jsxs("div",{children:["IBAN: ",I.iban]}),e.jsxs("div",{children:["البنك: ",I.bank]}),e.jsxs("div",{children:["المرجع: ",e.jsx("strong",{children:I.reference})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"بعد التحويل سيتم تأكيد الطلب."})]}),h==="stc"&&J&&e.jsxs("div",{className:"bg-purple-50 border p-4 rounded text-sm space-y-2",children:[e.jsxs("div",{children:["Session ID: ",J]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn-primary flex-1",disabled:D,onClick:async()=>{try{_(!0);const s=await F();await _e({orderId:s,sessionId:J,success:!0}),Q()}catch(s){y(s.message)}finally{_(!1)}},children:"تأكيد (محاكاة)"}),e.jsx("button",{className:"btn-secondary flex-1",disabled:D,onClick:()=>{pe(null),y("تم إلغاء جلسة STC")},children:"إلغاء"})]})]}),ue&&e.jsx("div",{className:"text-sm text-gray-700",children:ue})]})]}),o.complete&&e.jsxs("div",{className:"text-center py-24",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"تم إرسال الطلب"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"سيتم توجيهك لصفحة الطلبات قريباً."}),e.jsx("a",{href:"/orders",className:"btn-primary",children:"عرض الطلبات"})]}),e.jsx("div",{className:"checkout-sticky-cta md:hidden",children:e.jsxs("div",{className:"inner",children:[e.jsxs("div",{className:"sum",children:["المجموع: ",e.jsxs("strong",{children:[(b+(S||0)-(x?.amount||0)+ +(Math.max(0,b-(x?.amount||0))*.15).toFixed(2)).toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsx("button",{className:"btn-secondary",onClick:()=>{if(o.realpay){u(s=>({...s,realpay:!1,review:!0}));try{document.querySelector(".checkout-summary")?.scrollIntoView({behavior:"smooth",block:"start"})}catch{}return}if(o.review){u(s=>({...s,review:!1,payment:!0}));try{document.querySelector(`button[onClick*="toggle('payment')"]`).scrollIntoView({behavior:"smooth",block:"start"})}catch{}return}if(o.payment){u(s=>({...s,payment:!1,address:!0}));try{document.querySelector(`button[onClick*="toggle('address')"]`).scrollIntoView({behavior:"smooth",block:"start"})}catch{}return}},children:"رجوع"}),e.jsx("button",{className:"btn-primary flex-1",onClick:async()=>{if(o.address){if(H()){u(s=>({...s,address:!1,payment:!0}));try{document.querySelector(`button[onClick*="toggle('payment')"]`).scrollIntoView({behavior:"smooth",block:"start"})}catch{}}else{const t=["name","email","city","line1","phone"].find(a=>!!l[a]);if(t){const a=document.getElementById(`shipping-${t==="line1"?"address":t}`);if(a&&typeof a.focus=="function"){a.focus();try{a.classList.add("field-flash"),setTimeout(()=>a.classList.remove("field-flash"),1e3)}catch{}}}}return}if(o.payment){try{await F(),u(s=>({...s,payment:!1,review:!0}));try{document.querySelector(".checkout-summary")?.scrollIntoView({behavior:"smooth",block:"start"})}catch{}}catch{}return}if(o.review){u(s=>({...s,realpay:!0}));try{document.querySelector("div.mt-10.border.rounded.overflow-hidden")?.scrollIntoView({behavior:"smooth",block:"start"})}catch{}return}if(o.realpay){h==="cod"&&Q();return}},children:"متابعة"})]})]})})]})};export{as as default};
