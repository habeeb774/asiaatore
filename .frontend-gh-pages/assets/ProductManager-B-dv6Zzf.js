import{r as l,j as s}from"./vendor.react-C0fmYGW5.js";import{b as x,f as q,u as H,l as Q}from"./index-8VDXgoeV.js";import{u as W}from"./StoreContext-B5IXdHW_.js";import"./vendor-CF_-ATCh.js";import"./vendor.router-2GzHiivc.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.tanstack-K6OTystZ.js";import"./vendor.leaflet-U7UpOlxs.js";/* empty css                     */const v={ts:0,data:null},$=60*1e3;function X(I={withCounts:1,ttl:$}){const{withCounts:u=1,ttl:o=$}=I||{},[c,g]=l.useState([]),[S,t]=l.useState(!1),[i,d]=l.useState(null),m=l.useRef(!0);return l.useEffect(()=>{m.current=!0;const y=Date.now(),j=v.data&&y-v.ts<o;async function U(){if(j){g(v.data);return}t(!0),d(null);try{const b=await x.listCategories({withCounts:u}),w=Array.isArray(b?.categories)?b.categories:[];v.data=w,v.ts=Date.now(),m.current&&g(w)}catch(b){m.current&&d(b)}finally{m.current&&t(!1)}}return U(),()=>{m.current=!1}},[u,o]),{categories:c,loading:S,error:i,refetch:async()=>{v.data=null,v.ts=0;const y=await x.listCategories({withCounts:u}),j=Array.isArray(y?.categories)?y.categories:[];return v.data=j,v.ts=Date.now(),m.current&&g(j),j}}}const E="my_store_seller_products",de=({embedded:I=!1})=>{const{user:u}=q()||{},o=u?.id||"seller-guest",c=W(),[g,S]=l.useState([]),[t,i]=l.useState({name:"",nameAr:"",nameEn:"",price:0,categoryId:"",categorySlug:"",images:[],videos:[],description:"",type:"physical",downloadUrl:""}),[d,m]=l.useState(null),[P,y]=l.useState(""),[j,U]=l.useState(!1),[b,w]=l.useState(""),D=H()?.locale||"ar",[f,O]=l.useState(!1),[R,z]=l.useState([]),[M,N]=l.useState(!1),[F,p]=l.useState(null),{categories:A}=X({withCounts:1,ttl:6e4}),k=l.useMemo(()=>f?R:c?(c.products||[]).filter(e=>e.sellerId===o):g,[f,R,c,o,g]),J=e=>e?.nameAr||e?.nameEn?D==="ar"?e.nameAr||e.nameEn||"":e.nameEn||e.nameAr||"":Q(e||{},D)||e?.name||"";l.useEffect(()=>{if(c&&!f){try{const e=localStorage.getItem(E),a=e?JSON.parse(e):{},r=a[o]||[];Array.isArray(r)&&r.length>0&&((c.products||[]).some(h=>h.sellerId===o)||(r.forEach(h=>c.addProduct({...h,sellerId:o})),delete a[o],localStorage.setItem(E,JSON.stringify(a))))}catch{}return}if(!f)try{const e=localStorage.getItem(E),a=e?JSON.parse(e):{};S(a[o]||[])}catch{S([])}},[o,c,f]),l.useEffect(()=>{let e=!0;async function a(){if(!u||u.role!=="seller"&&u.role!=="admin"){O(!1);return}N(!0),p(null);try{const r=await x.sellerProductsList({pageSize:100});if(!e)return;const n=Array.isArray(r?.items)?r.items:Array.isArray(r)?r:[];z(n),O(!0)}catch{if(!e)return;O(!1)}finally{e&&N(!1)}}return a(),()=>{e=!1}},[u?.id,u?.role]);const L=e=>{try{const a=localStorage.getItem(E),r=a?JSON.parse(a):{};r[o]=e,localStorage.setItem(E,JSON.stringify(r)),S(e)}catch{}},C=()=>{i({name:"",nameAr:"",nameEn:"",price:0,categoryId:"",categorySlug:"",images:[],videos:[],description:"",type:"physical",downloadUrl:""}),y(""),w("")},_=async()=>{try{const e=await x.sellerProductsList({pageSize:100}),a=Array.isArray(e?.items)?e.items:Array.isArray(e)?e:[];z(a)}catch{}},V=async()=>{const e=(t.nameAr||t.name||"").trim(),a=(t.nameEn||t.name||"").trim();if(!e||!a){p("الاسم العربي والإنجليزي مطلوبان");return}if(f){N(!0),p(null);try{const n=A.find(Y=>String(Y.id)===String(t.categoryId)),h={nameAr:e,nameEn:a,price:Number(t.price)||0,categoryId:t.categoryId||void 0,category:n?.slug||"supermarket",image:t.images&&t.images[0]||void 0},T=await x.sellerProductCreate(h);T?.id&&(t.images?.length||0)>1&&await x.sellerProductAddImages(T.id,t.images.slice(0,8)),await _(),C()}catch(n){p(n?.message||"فشل إنشاء المنتج")}finally{N(!1)}return}const r={id:`p_${Date.now()}`,name:e||a,price:Number(t.price)||0,images:t.images,videos:t.videos,description:t.description,sellerId:o,type:t.type,downloadUrl:t.downloadUrl};if(c)c.addProduct(r);else{const n=[r,...g];L(n)}C()},B=async e=>{if(f){N(!0),p(null);try{await x.sellerProductDelete(e),await _()}catch(a){p(a?.message||"فشل الحذف")}finally{N(!1)}d===e&&m(null);return}if(c)c.removeProduct(e);else{const a=g.filter(r=>r.id!==e);L(a)}d===e&&m(null)},G=e=>{m(e.id);const a=A.find(r=>String(r.id)===String(e.categoryId));i({name:e.name||"",nameAr:e.nameAr||e.name||"",nameEn:e.nameEn||e.name||"",price:e.price||0,categoryId:e.categoryId||a?.id||"",categorySlug:e.category||a?.slug||"",images:e.images||(e.image?[e.image]:[]),videos:e.videos||[],description:e.description||"",type:e.type||"physical",downloadUrl:e.downloadUrl||""}),y(""),w("")},K=async()=>{if(d){if(f){N(!0),p(null);try{const e=A.find(a=>String(a.id)===String(t.categoryId));await x.sellerProductUpdate(d,{nameAr:(t.nameAr||t.name||"").trim(),nameEn:(t.nameEn||t.name||"").trim(),price:Number(t.price)||0,categoryId:t.categoryId||void 0,category:e?.slug||void 0,image:t.images&&t.images[0]||void 0}),t.images?.length>1&&await x.sellerProductAddImages(d,t.images.slice(0,8)),await _()}catch(e){p(e?.message||"فشل حفظ التعديلات")}finally{N(!1)}m(null),C();return}if(c)c.updateProduct(d,{name:t.nameAr||t.nameEn||t.name,price:Number(t.price)||0,images:t.images,videos:t.videos,description:t.description,type:t.type,downloadUrl:t.downloadUrl});else{const e=g.map(a=>a.id===d?{...a,name:t.nameAr||t.nameEn||t.name,price:Number(t.price)||0,images:t.images,videos:t.videos,description:t.description,type:t.type,downloadUrl:t.downloadUrl}:a);L(e)}m(null),C()}};return s.jsxs("div",{className:I?"":"container-custom px-4 py-8",children:[!I&&s.jsx("h2",{className:"text-2xl font-bold mb-4",children:"إدارة منتجات البائع"}),s.jsxs("div",{className:"mb-6 max-w-md",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mb-2",children:[s.jsx("input",{className:"w-full border px-3 py-2",placeholder:"اسم المنتج (عربي)",value:t.nameAr,onChange:e=>i({...t,nameAr:e.target.value})}),s.jsx("input",{className:"w-full border px-3 py-2",placeholder:"Product Name (English)",value:t.nameEn,onChange:e=>i({...t,nameEn:e.target.value})})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mb-2",children:[s.jsx("input",{className:"w-full border px-3 py-2",placeholder:"السعر",type:"number",value:t.price,onChange:e=>i({...t,price:e.target.value})}),s.jsxs("select",{className:"w-full border px-3 py-2",value:t.categoryId,onChange:e=>{const a=e.target.value,r=A.find(n=>String(n.id)===String(a));i({...t,categoryId:a,categorySlug:r?.slug||""})},children:[s.jsx("option",{value:"",children:"— اختر القسم —"}),A.map(e=>s.jsx("option",{value:e.id,children:D==="ar"?e.name?.ar||e.slug:e.name?.en||e.slug},e.id))]})]}),s.jsx("label",{className:"block text-sm mb-1",children:"صور المنتج (روابط)"}),s.jsxs("div",{className:"mb-2",children:[f&&d&&s.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[s.jsx("input",{type:"file",accept:"image/*",onChange:async e=>{const a=e.target.files?.[0];if(a)try{U(!0),p(null);const r=await x.sellerProductUploadImage(d,a);if(r?.url){const n=[r.url,...t.images||[]];i({...t,images:n}),await _()}}catch(r){p(r?.message||"فشل رفع الصورة")}finally{U(!1)}}}),j&&s.jsx("span",{className:"text-xs text-gray-500",children:"يرفع..."})]}),(t.images||[]).map((e,a)=>s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx("img",{src:e,alt:`img-${a}`,style:{width:72,height:56,objectFit:"cover",borderRadius:6}}),s.jsx("input",{className:"flex-1 border px-3 py-2",value:e,onChange:r=>{const n=[...t.images];n[a]=r.target.value,i({...t,images:n})}}),s.jsx("button",{className:"text-red-600",onClick:()=>{const r=t.images.filter((n,h)=>h!==a);i({...t,images:r})},children:"حذف"})]},a)),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{className:"flex-1 border px-3 py-2",placeholder:"أدخل رابط صورة واضغط إضافة",value:P,onChange:e=>y(e.target.value)}),s.jsx("button",{className:"btn-secondary",onClick:()=>{P.trim()&&(i({...t,images:[...t.images||[],P.trim()]}),y(""))},children:"إضافة"})]})]}),s.jsx("label",{className:"block text-sm mb-1",children:"فيديوهات المنتج (روابط)"}),s.jsxs("div",{className:"mb-2",children:[(t.videos||[]).map((e,a)=>s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx("input",{className:"flex-1 border px-3 py-2",value:e,onChange:r=>{const n=[...t.videos];n[a]=r.target.value,i({...t,videos:n})}}),s.jsx("button",{className:"text-red-600",onClick:()=>{const r=t.videos.filter((n,h)=>h!==a);i({...t,videos:r})},children:"حذف"})]},a)),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{className:"flex-1 border px-3 py-2",placeholder:"أدخل رابط فيديو واضغط إضافة",value:b,onChange:e=>w(e.target.value)}),s.jsx("button",{className:"btn-secondary",onClick:()=>{b.trim()&&(i({...t,videos:[...t.videos||[],b.trim()]}),w(""))},children:"إضافة"})]})]}),s.jsxs("div",{className:"mb-2",children:[s.jsx("label",{className:"block text-sm mb-1",children:"نوع المنتج"}),s.jsxs("select",{className:"w-full border px-3 py-2 mb-2",value:t.type,onChange:e=>i({...t,type:e.target.value}),children:[s.jsx("option",{value:"physical",children:"منتج مادي"}),s.jsx("option",{value:"digital",children:"منتج رقمي (تحميل)"})]}),t.type==="digital"&&s.jsx("input",{className:"w-full border px-3 py-2",placeholder:"رابط التحميل/الملف",value:t.downloadUrl,onChange:e=>i({...t,downloadUrl:e.target.value})})]}),s.jsx("textarea",{className:"w-full mb-2 border px-3 py-2",placeholder:"الوصف",value:t.description,onChange:e=>i({...t,description:e.target.value})}),d?s.jsxs("div",{style:{display:"flex",gap:8},children:[s.jsx("button",{className:"btn-primary",onClick:K,children:"حفظ التعديلات"}),s.jsx("button",{className:"btn-secondary",onClick:()=>{m(null),C()},children:"إلغاء"})]}):s.jsx("button",{className:"btn-primary",onClick:V,children:"إضافة منتج"})]}),s.jsxs("div",{className:"space-y-4",children:[M&&s.jsx("div",{className:"text-sm text-gray-500",children:"جاري التنفيذ..."}),F&&s.jsx("div",{className:"text-sm text-red-600",children:String(F)}),k&&k.map(e=>s.jsxs("div",{className:"p-3 border rounded flex items-center justify-between",children:[s.jsxs("div",{className:"flex items-center gap-4",children:[e.images&&e.images.length>0?s.jsx("img",{src:e.images[0],alt:J(e),className:"w-16 h-16 object-cover rounded"}):e.image?s.jsx("img",{src:e.image,alt:J(e),className:"w-16 h-16 object-cover rounded"}):s.jsx("div",{className:"w-16 h-16 bg-gray-200"}),s.jsxs("div",{children:[s.jsx("div",{className:"font-semibold",children:J(e)}),s.jsxs("div",{className:"text-sm text-gray-600",children:[e.price," ر.س"]})]})]}),s.jsxs("div",{children:[s.jsx("button",{className:"text-blue-600 mr-3",onClick:()=>G(e),children:"تعديل"}),s.jsx("button",{className:"text-red-600",onClick:()=>B(e.id),children:"حذف"})]})]},e.id)),(!k||k.length===0)&&s.jsxs("div",{className:"p-4 border rounded bg-white text-sm",children:[s.jsx("div",{className:"mb-2",children:"لا توجد منتجات لديك"}),s.jsx("button",{className:"btn-primary",onClick:()=>{const e={id:`p_${Date.now()}`,name:"منتج تجريبي",price:25,images:["/vite.svg"],description:"وصف مختصر للمنتج التجريبي",sellerId:o};c?c.addProduct(e):L([e,...g||[]])},children:"إنشاء منتج تجريبي سريع"})]})]})]})};export{de as default};
