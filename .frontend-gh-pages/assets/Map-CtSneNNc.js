import{r,j as e,ac as q,ad as K}from"./vendor.react-C0fmYGW5.js";import{f as Q,b as S}from"./index-B0cb22ux.js";import{R as X}from"./reactLeafletCompat-Bj-8Vu1M.js";import{B as y}from"./Button-DeEIw2lQ.js";import{B as I}from"./badge-DJ6kqs7A.js";import"./vendor-CF_-ATCh.js";import"./vendor.router-2GzHiivc.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.tanstack-K6OTystZ.js";import"./vendor.leaflet-U7UpOlxs.js";/* empty css                     */const Y="+966500000000";function ee({orderId:c,user:d}){const[m,C]=r.useState(null),[j,v]=r.useState([]),[h,u]=r.useState(""),N=r.useRef(null),[f,w]=r.useState(!1);r.useEffect(()=>{if(!c)return;let i=!0;return(async()=>{try{const p=await(await fetch("/api/support/chats",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({orderId:c,userId:d?.id||null,driverId:d?.id||null})})).json();if(!i)return;C(p.chatId)}catch(o){console.error("create chat error",o)}})(),()=>{i=!1}},[c,d]),r.useEffect(()=>{if(!m)return;let i=!0;(async()=>{try{const p=await(await fetch(`/api/support/chats/${m}/messages`)).json();i&&v(p.messages||[])}catch(o){console.error(o)}})();try{const o=new EventSource(`/api/support/chats/${m}/stream`);o.addEventListener("message",p=>{try{const k=JSON.parse(p.data||"{}");v(O=>O.concat([k]))}catch{}}),N.current=o}catch{}return()=>{i=!1;try{N.current?.close()}catch{}}},[m]);const g=async()=>{if(!(!m||!h.trim())){w(!0);try{const o=await(await fetch(`/api/support/chats/${m}/messages`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({from:"driver",text:h})})).json();o?.message&&v(p=>p.concat([o.message])),u("")}catch(i){console.error("send message",i)}finally{w(!1)}}};return e.jsxs("div",{className:"mt-3 border rounded p-2 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold text-sm",children:"التواصل مع الدعم"}),e.jsxs("div",{className:"text-xs text-gray-500",children:["#",c?c.slice(0,8):"—"]})]}),e.jsxs("div",{className:"space-y-2 max-h-40 overflow-auto text-sm mb-2",children:[j.length===0&&e.jsx("div",{className:"text-xs text-gray-500",children:"لا توجد رسائل بعد"}),j.map(i=>e.jsxs("div",{className:`p-2 rounded ${i.from==="driver"?"bg-blue-50 text-right":"bg-white text-left"}`,children:[e.jsx("div",{className:"text-xs text-gray-600",children:new Date(i.at).toLocaleTimeString("ar-SA")}),e.jsx("div",{children:i.text})]},i.id))]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"flex-1 border rounded px-2 py-1 text-sm",value:h,onChange:i=>u(i.target.value),placeholder:"أرسل رسالة للدعم..."}),e.jsx("button",{className:"px-3 py-1 bg-blue-600 text-white rounded text-sm",onClick:g,disabled:f||!h.trim(),children:"إرسال"})]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["أو",e.jsx("a",{className:"ml-2 text-blue-600 underline",href:`tel:${Y}`,children:"اتصل بالدعم"})]})]})}function me(){const{user:c}=Q()||{},[d,m]=r.useState(null),[C,j]=r.useState([]),[v,h]=r.useState([]),[u,N]=r.useState(""),[f,w]=r.useState("active"),[g,i]=r.useState(!1),[o,p]=r.useState(!1),[k,O]=r.useState(""),[A,H]=r.useState(""),[U,W]=r.useState(!1),M=r.useRef(null),[Z,F]=r.useState(!1),L=r.useRef(null),[R,D]=r.useState(!1),[$,T]=r.useState(""),[_,J]=r.useState(null),[B,G]=r.useState("");r.useEffect(()=>{try{const t=localStorage.getItem("lastLocation");if(t){const s=JSON.parse(t);s&&s.lat&&s.lng&&(m({lat:s.lat,lng:s.lng,accuracy:s.accuracy||null,at:s.at||Date.now()}),j(n=>n.concat([[s.lat,s.lng]])))}}catch{}},[]);const E=r.useCallback(async()=>{if(c&&["delivery","admin"].includes(c.role)){p(!0),O("");try{const t={};g&&(t.pool=1),f!=="active"&&f!=="all"&&(t.status=f);let n=(await S.deliveryList(t)).orders||[];f==="active"&&(n=n.filter(l=>["accepted","out_for_delivery"].includes(l.deliveryStatus))),h(n),n.length&&!u&&N(n[0].id)}catch(t){const s=t?.response?.data?.error||t?.message||"فشل جلب الطلبات";O(s),console.error("Fetch orders error:",t)}finally{p(!1)}}},[c,f,g,u]),V=r.useCallback(async()=>{if(!("geolocation"in navigator)){alert("المتصفح لا يدعم خدمة الموقع");return}if(!u){alert("اختر طلب لإرسال موقعك إليه");return}F(!0),L.current=navigator.geolocation.watchPosition(async t=>{const{latitude:s,longitude:n,accuracy:l}=t.coords;try{await S.deliveryLocation(u,{lat:s,lng:n,accuracy:l});const a={lat:s,lng:n,accuracy:l,at:Date.now()};m(a),j(x=>x.concat([[s,n]]).slice(-200));try{localStorage.setItem("lastLocation",JSON.stringify(a))}catch{}}catch(a){console.error("Location sharing error:",a)}},t=>{console.error("Geolocation error:",t),F(!1)},{enableHighAccuracy:!0,maximumAge:5e3,timeout:15e3})},[u]),P=r.useCallback(()=>{F(!1),L.current!=null&&navigator.geolocation&&(navigator.geolocation.clearWatch(L.current),L.current=null)},[]),z=r.useCallback(async(t,s,n=null)=>{if(!s){T("اختر طلب أولاً");return}D(!0),T("");try{switch(t){case"accept":await S.deliveryAccept(s),i(!1),w("accepted");break;case"start":await S.deliveryStart(s),h(l=>l.map(a=>a.id===s?{...a,deliveryStatus:"out_for_delivery"}:a));break;case"complete":{let l;if(_){const a=new FormData;a.append("proof",_),l=a}else l={note:"تم التسليم"};await S.deliveryComplete(s,l),h(a=>a.map(x=>x.id===s?{...x,deliveryStatus:"delivered"}:x)),P(),J(null);break}case"fail":if(!n?.reason){T("اذكر سبب الفشل");return}await S.deliveryFail(s,n.reason),h(l=>l.map(a=>a.id===s?{...a,deliveryStatus:"failed"}:a));break;default:return}await E()}catch(l){const a=l?.response?.data?.error||l?.message||`فشل ${t}`;T(a),console.error(`${t} error:`,l)}finally{D(!1)}},[_,P,E]);return r.useEffect(()=>{E()},[E]),r.useEffect(()=>{if(c&&["delivery","admin"].includes(c.role))try{const t=new EventSource("/api/events");return M.current=t,t.addEventListener("delivery.updated",s=>{try{const n=JSON.parse(s.data||"{}"),{orderId:l,deliveryStatus:a}=n||{};if(!l)return;h(x=>x.map(b=>b.id===l?{...b,deliveryStatus:a,...n}:b))}catch{}}),t.addEventListener("delivery.location",s=>{try{const n=JSON.parse(s.data||"{}");if(n?.deliveryLocation&&n.orderId===u){const{lat:l,lng:a,accuracy:x}=n.deliveryLocation||{};l&&a&&(m({lat:l,lng:a,accuracy:x||null,at:Date.now()}),j(b=>b.concat([[l,a]])))}}catch{}}),t.onerror=()=>{},()=>{t.close(),M.current=null}}catch{}},[c,u]),c?["delivery","admin"].includes(c.role)?e.jsxs("div",{className:"container mx-auto p-4 max-w-7xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{className:"w-6 h-6 text-blue-600"}),e.jsx("h1",{className:"text-xl font-bold",children:"خريطة التوصيل"})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:g,onChange:t=>i(t.target.checked)}),e.jsx("span",{children:"عرض طلبات غير المخصصة (Pool)"})]}),e.jsxs("select",{value:f,onChange:t=>w(t.target.value),className:"border rounded px-2 py-1",title:"تصفية الحالة",children:[e.jsx("option",{value:"active",children:"نشطة"}),e.jsx("option",{value:"accepted",children:"مقبولة"}),e.jsx("option",{value:"out_for_delivery",children:"خارج للتسليم"}),e.jsx("option",{value:"delivered",children:"تم التسليم"}),e.jsx("option",{value:"failed",children:"تعذر التسليم"}),e.jsx("option",{value:"all",children:"الكل"})]}),e.jsx(y,{onClick:E,disabled:o,children:o?"...تحديث":"تحديث"})]})]}),k&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded p-3 mb-3 text-red-700 text-sm flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{children:k})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx("div",{className:"h-[70vh] rounded overflow-hidden border",children:e.jsx(X,{children:t=>{const s=()=>{const l=t.useMap();return r.useEffect(()=>{try{const a=JSON.parse(localStorage.getItem("lastLocation"));a?.lat&&a?.lng&&l.setView([a.lat,a.lng],Math.max(l.getZoom(),14),{animate:!0})}catch{}},[l]),null},n=()=>{const l=t.useMap();return r.useEffect(()=>{const a=()=>l.invalidateSize(),x=setTimeout(a,100);return window.addEventListener("resize",a),()=>{clearTimeout(x),window.removeEventListener("resize",a)}},[l]),null};return e.jsxs(t.MapContainer,{center:[24.7136,46.6753],zoom:12,scrollWheelZoom:!0,className:"h-full w-full",children:[e.jsx(n,{}),e.jsx(s,{}),e.jsx(t.TileLayer,{url:U?"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png":"https://tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors",eventHandlers:{tileerror:()=>{W(!0),H("فشل تحميل بلاطات الخريطة — سيتم استخدام خريطة بديلة")}}}),d?.lat&&d?.lng&&e.jsx(t.Marker,{position:[d.lat,d.lng]}),C.length>1&&e.jsx(t.Polyline,{positions:C,color:"#3b82f6",weight:4,opacity:.7})]})}})}),A&&e.jsx("div",{className:"text-xs text-yellow-700 bg-yellow-50 border border-yellow-200 rounded p-2 mt-2",children:A})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"border rounded-lg p-3 bg-white space-y-3 max-h-[70vh] overflow-auto",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-semibold",children:"الطلبات"}),e.jsx(I,{color:"neutral",children:v.length})]}),!v.length&&e.jsx("div",{className:"text-sm text-gray-500",children:"لا توجد طلبات مطابقة للتصفية الحالية"}),v.map(t=>e.jsxs("div",{className:`rounded border p-2 ${u===t.id?"border-blue-400 bg-blue-50":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("button",{className:"text-right",onClick:()=>N(t.id),children:[e.jsxs("div",{className:"font-semibold",children:["#",t.id.slice(0,8),"..."]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["الحالة: ",t.deliveryStatus]})]}),e.jsx(I,{color:t.deliveryStatus==="out_for_delivery"?"info":t.deliveryStatus==="accepted"?"warning":t.deliveryStatus==="delivered"?"success":t.deliveryStatus==="failed"?"danger":"neutral",children:t.deliveryStatus})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[g&&e.jsx(y,{size:"sm",disabled:R,onClick:()=>z("accept",t.id),children:"استلام"}),!g&&t.deliveryStatus==="accepted"&&e.jsx(y,{size:"sm",disabled:R,onClick:()=>z("start",t.id),children:"بدء التسليم"}),!g&&t.deliveryStatus==="out_for_delivery"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"text-xs cursor-pointer inline-flex items-center gap-2",children:[e.jsx("input",{type:"file",className:"hidden",onChange:s=>J(s.target.files?.[0]||null)}),e.jsx("span",{className:"px-2 py-1 border rounded",children:"إرفاق إثبات"})]}),e.jsx(y,{size:"sm",variant:"success",disabled:R,onClick:()=>z("complete",t.id),children:"تم التسليم"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 text-xs",placeholder:"سبب الفشل",value:B,onChange:s=>G(s.target.value)}),e.jsx(y,{size:"sm",variant:"destructive",disabled:R,onClick:()=>z("fail",t.id,{reason:B||"تعذر الوصول"}),children:"تعذر التسليم"})]})]}),!!d&&e.jsx("a",{className:"text-xs text-blue-600 underline",href:`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(d.lat+","+d.lng)}`,target:"_blank",rel:"noreferrer",children:"فتح في الخرائط"})]})]},t.id)),$&&e.jsx("div",{className:"text-xs text-red-700 bg-red-50 border border-red-200 rounded p-2",children:$}),e.jsx("div",{className:"pt-3 border-t",children:e.jsx(ee,{orderId:u,user:c})}),e.jsxs("div",{className:"flex items-center gap-2 pt-2 border-t",children:[Z?e.jsx(y,{variant:"outline",onClick:P,children:"إيقاف المشاركة"}):e.jsx(y,{onClick:V,disabled:!u,children:"مشاركة موقعي"}),d&&e.jsxs("span",{className:"text-xs text-gray-500",children:["آخر تحديث: ",new Date(d.at||Date.now()).toLocaleTimeString("ar-SA")]})]})]})})]})]}):e.jsx("div",{className:"container mx-auto p-4",children:"غير مصرح بالوصول"}):e.jsx("div",{className:"container mx-auto p-4",children:"يجب تسجيل الدخول"})}export{me as default};
