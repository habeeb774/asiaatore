import{b as q,r,j as e}from"./vendor.react-C0fmYGW5.js";import{f as Q,b as c}from"./index-Df3LzoMm.js";import{B as d}from"./Button-DeEIw2lQ.js";import{B as I}from"./badge-US5Tt8Ec.js";import{R as U}from"./RoutePlanner-Ds5jK6F4.js";import"./vendor-CF_-ATCh.js";import"./vendor.router-2GzHiivc.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.tanstack-K6OTystZ.js";import"./vendor.leaflet-U7UpOlxs.js";/* empty css                     */const V=({className:l="",size:a=20})=>e.jsxs("svg",{className:l,width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("path",{d:"M1 3h13v13H1z",stroke:"currentColor",strokeWidth:"1.2",strokeLinejoin:"round",strokeLinecap:"round"}),e.jsx("path",{d:"M14 8h4l3 3v5",stroke:"currentColor",strokeWidth:"1.2",strokeLinejoin:"round",strokeLinecap:"round"}),e.jsx("circle",{cx:"7",cy:"18",r:"1.5",fill:"currentColor"}),e.jsx("circle",{cx:"19",cy:"18",r:"1.5",fill:"currentColor"})]}),$=({className:l="",size:a=18})=>e.jsxs("svg",{className:l,width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("path",{d:"M21 10a9 9 0 1 0-3 6.7L21 10z",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M21 3v7h-7",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round",strokeLinejoin:"round"})]}),X=({className:l="",size:a=16})=>e.jsxs("svg",{className:l,width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("path",{d:"M9 12l2 2 4-4",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"currentColor",strokeWidth:"1.2"})]}),Y=({className:l="",size:a=16})=>e.jsxs("svg",{className:l,width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M12 8v5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("path",{d:"M12 16h.01",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"})]}),Z=({className:l="",size:a=14})=>e.jsxs("svg",{className:l,width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M14 2v6h6",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M16 13c.5-1 2-1 3 0s2 1 3 0",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round",strokeLinejoin:"round"})]}),ee=({className:l="",size:a=14})=>e.jsxs("svg",{className:l,width:a,height:a,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("circle",{cx:"7",cy:"11",r:"2",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9 11l9 9",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round"}),e.jsx("path",{d:"M20 20v-3",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round"})]});function xe(){const{user:l}=Q()||{},a=q(),[N,M]=r.useState([]),[F,B]=r.useState(!0),[O,u]=r.useState(null),[o,j]=r.useState(null),[C,P]=r.useState(""),[L,_]=r.useState(null),[f,D]=r.useState(""),[S,H]=r.useState(null),[g,A]=r.useState([]),[m,z]=r.useState("active"),[p,T]=r.useState(!1),y=r.useRef(null),W=r.useRef(null),k=r.useRef(null),h=r.useCallback(async()=>{try{B(!0);const t={};p&&(t.pool=1),m!=="active"&&m!=="all"&&(t.status=m);let n=(await c.deliveryList(t))?.orders||[];m==="active"&&(n=n.filter(i=>["accepted","out_for_delivery"].includes(i.deliveryStatus))),M(n),u(null)}catch(t){console.error("fetchOrders error",t),u(t?.response?.data?.message||t?.message||"فشل تحميل الطلبات")}finally{B(!1)}},[p,m]),E=r.useCallback(async()=>{try{const t=await c.deliveryProfileGet();H(t?.profile||t||null)}catch(t){console.warn("fetchProfile",t)}},[]),v=r.useCallback(async(t,s,n=null)=>{try{switch(t){case"accept":await c.deliveryAccept(s);break;case"reject":await c.deliveryReject(s);break;case"start":await c.deliveryStart(s),j(s);break;case"complete":if(L){const i=new FormData;i.append("signature",L),await c.deliverySignature(s,i)}await c.deliveryComplete(s,{}),_(null),j(null);break;case"fail":await c.deliveryFail(s,n?.reason||f||"تعذر التسليم"),j(null);break;case"otp":await c.deliveryOtpConfirm(s,C),P("");break;default:return}await h()}catch(i){console.error(`${t} error`,i),u(`فشل ${t}: ${i?.message||"حدث خطأ"}`)}},[L,C,f,h]),w=r.useCallback(()=>{if(!("geolocation"in navigator)){u("المتصفح لا يدخدم نظام الموقع");return}try{const t=navigator.geolocation.watchPosition(async s=>{const{latitude:n,longitude:i}=s.coords;if(o)try{await c.deliveryLocation(o,{lat:n,lng:i})}catch(x){console.warn("location update failed",x)}},s=>{console.warn("geo error",s),u("فشل في الحصول على الموقع")},{enableHighAccuracy:!0,maximumAge:1e4,timeout:15e3});y.current=t}catch(t){console.warn("startLocationWatch error",t)}},[o]),b=r.useCallback(()=>{y.current!=null&&(navigator.geolocation.clearWatch(y.current),y.current=null)},[]);r.useEffect(()=>{if(l&&["delivery","admin"].includes(l.role)){E(),h(),w(),W.current=setInterval(h,2e4);try{const t=new EventSource("/api/events");k.current=t,t.addEventListener("delivery.updated",s=>{try{const n=JSON.parse(s.data||"{}"),{orderId:i,deliveryStatus:x}=n||{};if(!i)return;M(K=>K.map(R=>R.id===i?{...R,deliveryStatus:x}:R))}catch{}}),t.onerror=()=>{}}catch{}return()=>{if(W.current&&clearInterval(W.current),b(),k.current){try{k.current.close()}catch{}k.current=null}}}},[l,h,E,w,b]),r.useEffect(()=>{o?w():b()},[o,w,b]);function G(t){if(!t)return null;if(t.lat&&t.lng)return{lat:+t.lat,lng:+t.lng};if(t.location&&t.location.lat&&t.location.lng)return{lat:+t.location.lat,lng:+t.location.lng};if(t.deliveryLocation&&t.deliveryLocation.lat&&t.deliveryLocation.lng)return{lat:+t.deliveryLocation.lat,lng:+t.deliveryLocation.lng};if(t.toLat&&t.toLng)return{lat:+t.toLat,lng:+t.toLng};if(t.destination&&t.destination.lat&&t.destination.lng)return{lat:+t.destination.lat,lng:+t.destination.lng};if(t.address&&t.address.lat&&t.address.lng)return{lat:+t.address.lat,lng:+t.address.lng};if(t.coords&&typeof t.coords=="string"){const s=t.coords.split(",").map(n=>n.trim());if(s.length>=2)return{lat:+s[0],lng:+s[1]}}return null}function J(t){if(g.find(x=>x.id===t.id)){A(g.filter(x=>x.id!==t.id));return}const n=G(t);if(!n){u("لا يمكن إضافة هذا الطلب للمسار — لا توجد إحداثيات.");return}const i=t.customer&&(t.customer.name||t.customer.fullName)||t.address&&(t.address.line1||t.address.display)||`#${String(t.id).slice(0,8)}`;A([...g,{id:t.id,lat:n.lat,lng:n.lng,label:i}])}return l?["delivery","admin"].includes(l.role)?e.jsx("div",{className:"min-h-screen p-4 bg-gray-50",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("header",{className:"flex items-center justify-between py-4 mb-4 bg-white rounded-lg shadow-sm px-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{className:"w-6 h-6 text-blue-600"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"لوحة تحكم الموزع"}),S&&e.jsxs("p",{className:"text-xs text-gray-600 mt-0.5",children:["الحالة: ",S?.profile?.status||S?.status||"—"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:t=>T(t.target.checked)}),e.jsx("span",{children:"عرض طلبات Pool"})]}),e.jsxs("select",{value:m,onChange:t=>z(t.target.value),className:"border rounded px-2 py-1",title:"تصفية الحالة",children:[e.jsx("option",{value:"active",children:"نشطة"}),e.jsx("option",{value:"accepted",children:"مقبولة"}),e.jsx("option",{value:"out_for_delivery",children:"خارج للتسليم"}),e.jsx("option",{value:"delivered",children:"تم التسليم"}),e.jsx("option",{value:"failed",children:"تعذر التسليم"}),e.jsx("option",{value:"all",children:"الكل"})]}),e.jsx(d,{onClick:h,children:e.jsx($,{className:"w-4 h-4"})}),e.jsx(d,{onClick:()=>a("/delivery/summary"),children:"ملخص الرحلة"})]})]}),O&&e.jsxs("div",{className:"p-3 mb-4 rounded-lg bg-red-50 border border-red-200 text-red-700 flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:O}),e.jsx("button",{onClick:()=>u(null),className:"ml-auto text-red-500 hover:text-red-700",children:"✕"})]}),e.jsxs("section",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:"الطلبات"}),e.jsx(I,{color:"neutral",children:N.length})]}),e.jsxs("div",{className:"space-y-2 max-h-[70vh] overflow-auto",children:[F&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-12 bg-gray-100 rounded animate-pulse"}),e.jsx("div",{className:"h-12 bg-gray-100 rounded animate-pulse"}),e.jsx("div",{className:"h-12 bg-gray-100 rounded animate-pulse"})]}),!F&&N.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"لا توجد طلبات مطابقة للتصفية الحالية"}),N.map(t=>e.jsxs("div",{className:`rounded border p-2 ${o===t.id?"border-blue-400 bg-blue-50":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"inline-flex items-center gap-2",children:e.jsx("input",{type:"checkbox",checked:!!g.find(s=>s.id===t.id),onChange:()=>J(t)})}),e.jsxs("button",{className:"text-right",onClick:()=>j(t.id),children:[e.jsxs("div",{className:"font-semibold",children:["#",t.id.slice(0,8),"..."]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["الحالة: ",t.deliveryStatus]})]})]}),e.jsx(I,{color:t.deliveryStatus==="out_for_delivery"?"info":t.deliveryStatus==="accepted"?"warning":t.deliveryStatus==="delivered"?"success":t.deliveryStatus==="failed"?"danger":"neutral",children:t.deliveryStatus})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[p&&e.jsx(d,{size:"sm",onClick:()=>v("accept",t.id),children:"استلام"}),!p&&t.deliveryStatus==="accepted"&&e.jsx(d,{size:"sm",onClick:()=>v("start",t.id),children:"بدء التسليم"}),!p&&t.deliveryStatus==="out_for_delivery"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"text-xs cursor-pointer inline-flex items-center gap-2",children:[e.jsx("input",{type:"file",className:"hidden",onChange:s=>_(s.target.files?.[0]||null)}),e.jsxs("span",{className:"px-2 py-1 border rounded inline-flex items-center gap-1",children:[e.jsx(Z,{className:"w-4 h-4"})," توقيع"]})]}),e.jsxs(d,{size:"sm",variant:"success",onClick:()=>v("complete",t.id),children:[e.jsx(X,{className:"w-4 h-4"})," تم التسليم"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 text-xs",placeholder:"سبب الفشل",value:f,onChange:s=>D(s.target.value)}),e.jsx(d,{size:"sm",variant:"destructive",onClick:()=>v("fail",t.id,{reason:f||"تعذر الوصول"}),children:"تعذر التسليم"})]})]}),t.deliveryStatus!=="delivered"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 text-xs",placeholder:"OTP",value:C,onChange:s=>P(s.target.value)}),e.jsxs(d,{size:"sm",variant:"outline",onClick:()=>v("otp",t.id),children:[e.jsx(ee,{className:"w-4 h-4"})," تحقق"]})]})]})]},t.id))]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border p-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"خريطة وتخطيط المسار"}),e.jsx(U,{stops:g}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"تفاصيل الطلب"}),!o&&e.jsx("div",{className:"text-sm text-gray-500",children:"اختر طلباً من القائمة لعرض التفاصيل"}),o&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",children:["المعرف: ",e.jsx("span",{className:"font-mono",children:o})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"استخدم الخريطة أعلاه لعرض الطريق الحي"}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs(d,{onClick:h,size:"sm",variant:"outline",children:[e.jsx($,{className:"w-4 h-4"})," تحديث"]})})]})]})]})]})]})}):e.jsx("div",{className:"min-h-screen p-4 bg-gray-50",children:"غير مصرح بالوصول"}):e.jsx("div",{className:"min-h-screen p-4 bg-gray-50",children:"يجب تسجيل الدخول"})}export{xe as default};
