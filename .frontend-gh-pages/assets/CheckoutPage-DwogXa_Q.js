import{r as c,j as e}from"./vendor.react-C0fmYGW5.js";import{R as Fe}from"./reactLeafletCompat-Bj-8Vu1M.js";import{i as Me,c as Oe,a as Re,b as Ae}from"./paymentService-BEp1tRVd.js";import{a as _e,f as $e,u as qe,g as Te,b as w,l as Be}from"./index-8VDXgoeV.js";import"./vendor-CF_-ATCh.js";import"./vendor.router-2GzHiivc.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.tanstack-K6OTystZ.js";import"./vendor.leaflet-U7UpOlxs.js";/* empty css                     */const Ze=()=>{const{cartItems:j,clearCart:Q}=_e()||{},{user:v}=$e()||{},xe=qe()?.locale??"ar",[o,m]=c.useState({address:!0,payment:!1,review:!1,realpay:!1,complete:!1}),W=s=>m(t=>({...t,[s]:!t[s]})),X="my_store_checkout_address",D=()=>{try{const s=localStorage.getItem(X);if(s)return JSON.parse(s)}catch{}return{name:v?.name||"",email:v?.email||"",country:"SA",city:"",line1:"",phone:"",geo:null}},[r,y]=c.useState(D),[k,V]=c.useState(()=>D()?.geo||null),[Z,G]=c.useState(!1),[ee,C]=c.useState(""),[se,ye]=c.useState([]),[fe,te]=c.useState(""),[i,K]=c.useState({}),[d,f]=c.useState({}),ae="my_store_last_coupon",[M,ge]=c.useState(()=>{try{return localStorage.getItem(ae)||""}catch{return""}}),[h,O]=c.useState(null),[S,I]=c.useState(0),[N,R]=c.useState(null),[ne,re]=c.useState(!1),[A,be]=c.useState(null),[ie,le]=c.useState(null),[p,ce]=c.useState("cod"),[_,$]=c.useState(!1),[oe,x]=c.useState(""),[E,je]=c.useState(null),[U,de]=c.useState(null),{refresh:De}=Te()||{},g=c.useMemo(()=>(j||[]).reduce((s,t)=>s+(t.price||0)*(t.quantity||1),0),[j]);c.useEffect(()=>{(async()=>{const t=(r.city||"").trim();if(!t){I(0),R(null);return}try{const a=await w.shippingQuote({city:t,country:r.country});a?.ok?(I(Number(a.shipping)||0),R({method:a.method,distanceKm:a.distanceKm,cityMatched:a.cityMatched})):(I(25),R(null))}catch{I(25),R(null)}})()},[r.city,r.country]),c.useEffect(()=>{try{localStorage.setItem(X,JSON.stringify(r))}catch{}},[r]),c.useEffect(()=>{let s=!0;return(async()=>{if(v)try{const t=await w.addressesList(),a=t.addresses||t.items||[];if(!s)return;ye(a);const n=a.find(l=>l.isDefault)||a[0];n&&(te(n.id),y(l=>({...l,name:n.name||l.name,email:l.email,country:n.country||l.country,city:n.city||l.city,line1:n.street||l.line1,phone:n.phone||l.phone})))}catch{}})(),()=>{s=!1}},[v?.id]);const q=h?.amount||0,me=Math.max(0,g-q),T=+(me*.15).toFixed(2),ue=+(me+T+(S||0)).toFixed(2),b=(s,t)=>{const a=(t??"").toString();switch(s){case"name":return a.trim()?"":"الاسم مطلوب";case"email":return a.includes("@")&&/.+@.+\..+/.test(a)?"":"بريد غير صالح";case"city":return a.trim()?"":"المدينة مطلوبة";case"line1":return a.trim()?"":"العنوان مطلوب";case"phone":return a.trim()?"":"الهاتف مطلوب";default:return""}},B=()=>{const s={name:b("name",r.name),email:b("email",r.email),city:b("city",r.city),line1:b("line1",r.line1),phone:b("phone",r.phone)};return Object.keys(s).forEach(t=>{s[t]||delete s[t]}),K(s),f(t=>({...t,name:!0,email:!0,city:!0,line1:!0,phone:!0})),Object.keys(s).length===0},z=()=>{try{const s=["name","email","city","line1","phone"],t=s.find(l=>!!i[l])||s.find(l=>b(l,r[l]));if(!t)return;const a=`shipping-${t==="line1"?"address":t}`,n=document.getElementById(a);if(n&&typeof n.focus=="function"){n.focus(),n.scrollIntoView({behavior:"smooth",block:"center"});try{n.classList.add("field-flash"),setTimeout(()=>n.classList.remove("field-flash"),900)}catch{}}}catch{}},P=s=>t=>{const a=t?.target?.value??"";y(l=>({...l,[s]:a})),f(l=>({...l,[s]:!0}));const n=b(s,a);K(l=>{const u={...l};return n?u[s]=n:delete u[s],u})},ve=()=>{B()&&m(s=>({...s,address:!1,payment:!0}))},Ne=()=>{if(!M.trim())return;const s=M.trim().toUpperCase();s==="SAVE10"?O({code:s,amount:Math.min(10,g*.2)}):s==="FREESHIP"?(O({code:s,amount:0}),I(0)):O(s==="SAVE20"?{code:s,amount:Math.min(20,g*.3)}:null);try{localStorage.setItem(ae,s)}catch{}},pe=()=>({userId:v?.id||"guest",items:(j||[]).map(s=>({productId:typeof s.id=="string"&&!s.id.startsWith("p_")&&s.id.length>10&&typeof s.id=="string"?s.id:"custom",name:{ar:s.name?.ar||s.name||"صنف",en:s.name?.en||s.name||"Item"},price:typeof s.price=="number"?s.price:Number(s.price||0),quantity:Number.isFinite(Number(s.quantity))?Number(s.quantity):1,oldPrice:typeof s.oldPrice=="number"?s.oldPrice:s.oldPrice?Number(s.oldPrice):null})),currency:"SAR",paymentMethod:p,paymentMeta:{address:r,coupon:h?.code||null,shipping:S},discount:q,tax:T}),F=async(s=!1)=>{le(null);const t=pe();if(A&&!s)try{return await w.updateOrder(A,{items:t.items,paymentMethod:t.paymentMethod,paymentMeta:t.paymentMeta}),A}catch{}re(!0);try{const a=await w.createOrder(t);if(!a?.order?.id)throw new Error("Create failed");return be(a.order.id),a.order.id}catch(a){try{console.error("[ORDER_CREATE_ERROR]",a),a?.data&&console.error("[ORDER_CREATE_ERROR].data",a.data)}catch{}throw le("تعذر إنشاء الطلب حالياً. الرجاء المحاولة مرة أخرى."),a}finally{re(!1)}},we=async()=>{if(!B()){z();return}try{await F(),m(s=>({...s,address:!1,payment:!1,review:!0}))}catch{z()}},ke=async()=>{if(!B()){m(s=>({...s,address:!0,payment:!1,review:!1,realpay:!1})),z();return}try{await F(),m(s=>({...s,realpay:!0}))}catch{}},H=()=>{Q&&Q(),m({address:!1,payment:!1,review:!1,realpay:!1,complete:!0})},Ce=!j?.length&&!o.complete,Se=c.useMemo(()=>({_placeholder:!0}),[]),J=async(s,t)=>{C("");try{const a=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(s)}&lon=${encodeURIComponent(t)}&zoom=16&addressdetails=1`,n=await fetch(a,{headers:{Accept:"application/json"}});if(!n.ok)throw new Error("GEOCODE_FAILED");const l=await n.json(),u=l.address||{},Ee=u.city||u.town||u.village||u.county||u.state||"",Pe=u.road||u.neighbourhood||u.suburb||u.hamlet||u.quarter||l.display_name||"";y(Y=>({...Y,city:Ee||Y.city,line1:Pe||Y.line1,geo:{lat:s,lng:t}}))}catch{y(n=>({...n,geo:{lat:s,lng:t}})),C("تعذر تحديد العنوان تلقائياً. يمكنك إدخال المدينة والعنوان يدوياً.")}},Ie=()=>{if(!("geolocation"in navigator)){C("المتصفح لا يدعم GPS");return}G(!0),C("جارِ تحديد موقعك..."),navigator.geolocation.getCurrentPosition(s=>{const{latitude:t,longitude:a}=s.coords;V({lat:t,lng:a}),J(t,a).finally(()=>G(!1))},s=>{G(!1),C(s?.message?`تعذر الوصول للموقع: ${s.message}`:"تعذر الوصول للموقع")},{enableHighAccuracy:!0,maximumAge:5e3,timeout:15e3})},L=o.review||o.payment||o.realpay||o.complete?2:o.address?1:0,he=Math.round((L+1)/3*100);return e.jsxs("div",{className:"container-custom px-4 py-12 checkout-page-enhanced",children:[Ce&&e.jsx("div",{className:"mb-6",children:e.jsx("h2",{className:"text-xl font-bold",children:"السلة فارغة"})}),e.jsxs("div",{className:"checkout-progress mobile-gutters",role:"progressbar","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":he,children:[e.jsx("div",{className:"checkout-progress__bar",children:e.jsx("span",{style:{width:`${he}%`}})}),e.jsxs("div",{className:"checkout-progress__labels",children:[e.jsx("span",{className:L>=0?"is-active":"",children:"السلة"}),e.jsx("span",{className:L>=1?"is-active":"",children:"العنوان"}),e.jsx("span",{className:L>=2?"is-active":"",children:"الدفع"})]})]}),e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"الدفع (Checkout)"}),e.jsxs("ol",{className:"flex items-center gap-3 text-xs text-gray-600 mb-4",children:[e.jsx("li",{className:`px-2 py-1 rounded ${o.address?"bg-green-100 text-green-800":"bg-gray-100"}`,children:"1. العنوان"}),e.jsx("li",{className:`px-2 py-1 rounded ${o.payment?"bg-green-100 text-green-800":"bg-gray-100"}`,children:"2. الشحن والدفع"}),e.jsx("li",{className:`px-2 py-1 rounded ${o.review?"bg-green-100 text-green-800":"bg-gray-100"}`,children:"3. المراجعة"}),e.jsx("li",{className:`px-2 py-1 rounded ${o.realpay?"bg-green-100 text-green-800":"bg-gray-100"}`,children:"4. الدفع"})]}),e.jsxs("div",{className:"mb-4 border rounded overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:()=>W("address"),className:"w-full flex justify-between items-center px-4 py-3 bg-gray-50 text-sm font-semibold",children:[e.jsx("span",{children:"العنوان"}),e.jsx("span",{children:o.address?"−":"+"})]}),o.address&&e.jsxs("div",{className:"grid gap-4 max-w-xl p-4",children:[v&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-semibold",children:"اختر عنوان محفوظ"}),e.jsxs("select",{className:"border px-3 py-2",value:fe,onChange:s=>{const t=s.target.value;te(t);const a=se.find(n=>n.id===t);a&&y(n=>({...n,name:a.name||n.name,country:a.country||n.country,city:a.city||n.city,line1:a.street||n.line1,phone:a.phone||n.phone}))},children:[e.jsx("option",{value:"",children:"— بدون —"}),se.map(s=>e.jsxs("option",{value:s.id,children:[s.label||s.city||s.street," ",s.isDefault?"• افتراضي":""]},s.id))]}),e.jsxs("div",{className:"text-xs",children:["لإدارة العناوين: ",e.jsx("a",{href:"/account/addresses",className:"text-primary-red",children:"عناويني"})]})]}),e.jsx("input",{id:"shipping-name",name:"name",autoComplete:"name",className:`border px-3 py-2 ${d.name&&i.name?"is-invalid":""}`,placeholder:"الاسم",value:r.name,onChange:P("name"),onBlur:()=>f(s=>({...s,name:!0})),"aria-invalid":!!(d.name&&i.name),"aria-describedby":d.name&&i.name?"err-name":void 0}),d.name&&i.name&&e.jsx("div",{id:"err-name",className:"field-hint",children:i.name}),e.jsx("input",{id:"shipping-email",name:"email",type:"email",autoComplete:"email",className:`border px-3 py-2 ${d.email&&i.email?"is-invalid":""}`,placeholder:"البريد",value:r.email,onChange:P("email"),onBlur:()=>f(s=>({...s,email:!0})),"aria-invalid":!!(d.email&&i.email),"aria-describedby":d.email&&i.email?"err-email":void 0}),d.email&&i.email&&e.jsx("div",{id:"err-email",className:"field-hint",children:i.email}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx("input",{id:"shipping-country",name:"country",autoComplete:"country-name",className:"border px-3 py-2",placeholder:"الدولة",value:r.country,onChange:s=>y(t=>({...t,country:s.target.value}))}),e.jsx("input",{id:"shipping-city",name:"city",autoComplete:"address-level2",className:`border px-3 py-2 ${d.city&&i.city?"is-invalid":""}`,placeholder:"المدينة",value:r.city,onChange:P("city"),onBlur:()=>f(s=>({...s,city:!0})),"aria-invalid":!!(d.city&&i.city),"aria-describedby":d.city&&i.city?"err-city":void 0})]}),d.city&&i.city&&e.jsx("div",{id:"err-city",className:"field-hint",children:i.city}),e.jsx("input",{id:"shipping-address",name:"address1",autoComplete:"address-line1",className:`border px-3 py-2 ${d.line1&&i.line1?"is-invalid":""}`,placeholder:"العنوان",value:r.line1,onChange:P("line1"),onBlur:()=>f(s=>({...s,line1:!0})),"aria-invalid":!!(d.line1&&i.line1),"aria-describedby":d.line1&&i.line1?"err-line1":void 0}),d.line1&&i.line1&&e.jsx("div",{id:"err-line1",className:"field-hint",children:i.line1}),e.jsx("input",{id:"shipping-phone",name:"tel",type:"tel",autoComplete:"tel",className:`border px-3 py-2 ${d.phone&&i.phone?"is-invalid":""}`,placeholder:"الهاتف",value:r.phone,onChange:P("phone"),onBlur:()=>f(s=>({...s,phone:!0})),"aria-invalid":!!(d.phone&&i.phone),"aria-describedby":d.phone&&i.phone?"err-phone":void 0}),d.phone&&i.phone&&e.jsx("div",{id:"err-phone",className:"field-hint",children:i.phone}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",className:"btn-secondary",onClick:Ie,disabled:Z,children:Z?"...جارِ التحديد":"تحديد العنوان عبر GPS"}),r?.geo&&e.jsxs("span",{className:"text-xs text-gray-500",children:["(",r.geo.lat?.toFixed(5),", ",r.geo.lng?.toFixed(5),")"]})]}),ee&&e.jsx("div",{className:"text-xs text-gray-600",children:ee}),k&&e.jsxs("div",{className:"rounded border overflow-hidden",style:{height:260},children:[e.jsx(Fe,{children:s=>e.jsxs(s.MapContainer,{center:[k.lat,k.lng],zoom:15,style:{height:"100%",width:"100%"},children:[e.jsx(s.TileLayer,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"© OpenStreetMap contributors"}),e.jsx(s.Marker,{position:[k.lat,k.lng],icon:Se,draggable:!0,eventHandlers:{dragend:t=>{const n=t.target.getLatLng(),l={lat:n.lat,lng:n.lng};V(l),J(l.lat,l.lng)}}}),e.jsx(s.MapClicker,{onPick:t=>{V(t),J(t.lat,t.lng)}})]})}),e.jsx("div",{className:"p-2 text-xs text-gray-500",children:"يمكنك سحب العلامة أو النقر على الخريطة لاختيار نقطة التسليم."})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{className:"btn-primary flex-1",type:"button",onClick:ve,children:"حفظ و التالي"}),e.jsx("button",{className:"btn-secondary",type:"button",onClick:()=>{y(D()),K({})},children:"إعادة ضبط"})]})]})]}),e.jsxs("div",{className:"mb-4 border rounded overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:()=>W("payment"),className:"w-full flex justify-between items-center px-4 py-3 bg-gray-50 text-sm font-semibold",children:[e.jsx("span",{children:"الشحن و طريقة الدفع"}),e.jsx("span",{children:o.payment?"−":"+"})]}),o.payment&&e.jsxs("div",{className:"p-4 grid md:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"md:col-span-2 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold mb-2 text-sm",children:"طريقة الدفع"}),e.jsx("div",{className:"grid gap-2 text-sm",children:["cod","paypal","stc","bank"].map(s=>e.jsxs("label",{className:`border rounded p-2 flex items-center gap-2 cursor-pointer ${p===s?"ring-2 ring-primary-red":""}`,children:[e.jsx("input",{type:"radio",name:"pm2",value:s,checked:p===s,onChange:()=>ce(s)}),e.jsx("span",{children:s==="cod"?"الدفع عند الاستلام":s==="paypal"?"PayPal":s==="stc"?"STC Pay":"تحويل بنكي"})]},s))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold mb-2 text-sm",children:"قسيمة الخصم"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{id:"coupon",name:"coupon",className:"border px-3 py-2 flex-1 text-sm",placeholder:"رمز القسيمة",value:M,onChange:s=>ge(s.target.value)}),e.jsx("button",{className:"btn-secondary",type:"button",onClick:Ne,children:"تطبيق"})]}),h&&e.jsxs("div",{className:"text-xs text-green-600 mt-1",children:["تم تطبيق ",h.code," خصم: ",h.amount.toFixed(2)," ر.س"]}),!h&&M&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"لا يوجد خصم فعلي (رمز غير معروف)"})]})]}),e.jsxs("div",{className:"checkout-summary bg-white border rounded p-4 text-sm space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الإجمالي الفرعي"}),e.jsxs("span",{children:[g.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الخصم"}),e.jsxs("span",{children:[q.toFixed(2),"-"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الشحن"}),e.jsxs("span",{children:[S.toFixed(2)," ر.س"]})]}),N&&e.jsxs("div",{className:"text-xs text-gray-500",children:["طريقة التسعير: ",N.method==="distance"?`حسب المسافة (~${N.distanceKm} كم)`:"افتراضي"]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الضريبة"}),e.jsxs("span",{children:[T.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-bold",children:[e.jsx("span",{children:"الإجمالي"}),e.jsxs("span",{children:[ue.toFixed(2)," ر.س"]})]}),e.jsx("button",{disabled:ne,className:"btn-primary w-full",type:"button",onClick:we,children:ne?"...جاري الإنشاء":"مراجعة الطلب"}),ie&&e.jsxs("div",{className:"field-hint",children:["خطأ: ",ie]})]})]})]}),o.review&&e.jsxs("div",{className:"grid md:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"md:col-span-2 space-y-4",children:[e.jsxs("div",{className:"bg-white border rounded p-4",children:[e.jsx("h3",{className:"font-bold mb-3",children:"العنوان"}),e.jsxs("div",{className:"text-sm leading-relaxed",children:[e.jsx("div",{children:r.name}),e.jsx("div",{children:r.email}),e.jsxs("div",{children:[r.country," - ",r.city]}),e.jsx("div",{children:r.line1}),e.jsx("div",{children:r.phone})]}),e.jsx("button",{className:"text-xs text-primary-red mt-2",onClick:()=>m(s=>({...s,address:!0,review:!1})),children:"تعديل"})]}),e.jsxs("div",{className:"bg-white border rounded p-4",children:[e.jsx("h3",{className:"font-bold mb-3",children:"العناصر"}),e.jsx("ul",{className:"divide-y text-sm",children:j.map(s=>e.jsxs("li",{className:"py-2 flex items-center gap-3",children:[e.jsx("span",{className:"truncate flex-1 max-w-[160px]",children:Be(s,xe)}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",className:"px-2 border",onClick:()=>w,children:"-"}),e.jsx("input",{value:s.quantity,readOnly:!0,className:"w-10 border text-center text-xs"}),e.jsx("button",{type:"button",className:"px-2 border",onClick:()=>w,children:"+"})]}),e.jsxs("span",{className:"text-xs whitespace-nowrap",children:[(s.price||0).toFixed(2)," × ",s.quantity," = ",((s.price||0)*(s.quantity||1)).toFixed(2)]})]},s.id))})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"checkout-summary bg-white border rounded p-4 text-sm space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الإجمالي الفرعي"}),e.jsxs("strong",{children:[g.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الخصم"}),e.jsxs("strong",{children:[q.toFixed(2),"-"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الشحن"}),e.jsxs("strong",{children:[S.toFixed(2)," ر.س"]})]}),N&&e.jsx("div",{className:"text-xs text-gray-500",children:N.method==="distance"?`المسافة التقديرية: ~${N.distanceKm} كم`:"تسعير افتراضي للشحن"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"الضريبة"}),e.jsxs("strong",{children:[T.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"border-t pt-2 flex justify-between font-bold",children:[e.jsx("span",{children:"الإجمالي"}),e.jsxs("span",{children:[ue.toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["رقم الطلب: ",A||"—"," / طريقة: ",p]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx("button",{className:"btn-primary w-full",onClick:H,children:"تأكيد وإكمال (دفع عند الاستلام)"}),e.jsx("button",{type:"button",className:"btn-secondary w-full",onClick:ke,children:"طرق دفع حقيقية"})]})]})})]}),o.realpay&&!o.complete&&e.jsxs("div",{className:"mt-10 border rounded overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 px-4 py-3 flex justify-between items-center text-sm font-semibold",children:[e.jsx("span",{children:"طرق الدفع الحقيقية"}),e.jsx("button",{onClick:()=>m(s=>({...s,realpay:!1})),children:"إغلاق"})]}),e.jsxs("div",{className:"p-4 space-y-6 max-w-xl",children:[e.jsx("div",{className:"grid gap-3",children:["paypal","stc","bank","cod"].map(s=>e.jsxs("label",{className:`border rounded p-3 cursor-pointer flex items-center justify-between ${p===s?"ring-2 ring-primary-red":""}`,children:[e.jsxs("span",{children:[e.jsx("input",{type:"radio",name:"pm4",value:s,checked:p===s,onChange:()=>ce(s),className:"mr-2"}),s==="paypal"?"PayPal":s==="stc"?"STC Pay (محاكاة)":s==="bank"?"تحويل بنكي":"الدفع عند الاستلام"]}),e.jsx("span",{className:"text-xs text-gray-500",children:s==="paypal"?"الدفع الآمن":s==="stc"?"محفظة رقمية":s==="bank"?"دفع يدوي":"رسوم محتملة"})]},s))}),e.jsx("button",{className:"btn-primary w-full",disabled:_,onClick:async()=>{if(!j?.length){x("السلة فارغة");return}try{$(!0),x("");const s=await F();switch(p){case"cod":x("سيتم الاكتفاء بالدفع عند الاستلام. يمكنك إنهاء الطلب.");break;case"paypal":{const t=pe(),a=await Re({items:t.items,currency:t.currency});if(a?.approvalUrl)window.location.href=a.approvalUrl;else throw new Error("لا يوجد رابط موافقة");break}case"stc":{const t=await Oe({orderId:s});if(t?.sessionId)de(t.sessionId),x("تم إنشاء جلسة STC Pay");else throw new Error("فشل إنشاء الجلسة");break}case"bank":{const t=await Me({orderId:s});if(t?.bank)je(t.bank),x("تم تحميل بيانات البنك");else throw new Error("لا توجد بيانات بنك");break}default:break}}catch(s){x(s?.message||"حدث خطأ أثناء بدء الدفع. الرجاء المحاولة مرة أخرى.")}finally{$(!1)}},children:_?"...جاري المعالجة":"بدء عملية الدفع"}),p==="bank"&&E&&e.jsxs("div",{className:"bg-gray-50 border p-4 rounded text-sm space-y-1",children:[e.jsxs("div",{children:["اسم الحساب: ",E.accountName]}),e.jsxs("div",{children:["IBAN: ",E.iban]}),e.jsxs("div",{children:["البنك: ",E.bank]}),e.jsxs("div",{children:["المرجع: ",e.jsx("strong",{children:E.reference})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"بعد التحويل سيتم تأكيد الطلب."})]}),p==="stc"&&U&&e.jsxs("div",{className:"bg-purple-50 border p-4 rounded text-sm space-y-2",children:[e.jsxs("div",{children:["Session ID: ",U]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn-primary flex-1",disabled:_,onClick:async()=>{try{$(!0);const s=await F();await Ae({orderId:s,sessionId:U,success:!0}),H()}catch(s){x(s.message)}finally{$(!1)}},children:"تأكيد (محاكاة)"}),e.jsx("button",{className:"btn-secondary flex-1",disabled:_,onClick:()=>{de(null),x("تم إلغاء جلسة STC")},children:"إلغاء"})]})]}),oe&&e.jsx("div",{className:"text-sm text-gray-700",children:oe})]})]}),o.complete&&e.jsxs("div",{className:"text-center py-24",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:"تم إرسال الطلب"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"سيتم توجيهك لصفحة الطلبات قريباً."}),e.jsx("a",{href:"/orders",className:"btn-primary",children:"عرض الطلبات"})]}),e.jsx("div",{className:"checkout-sticky-cta md:hidden",children:e.jsxs("div",{className:"inner",children:[e.jsxs("div",{className:"sum",children:["المجموع: ",e.jsxs("strong",{children:[(g+(S||0)-(h?.amount||0)+ +(Math.max(0,g-(h?.amount||0))*.15).toFixed(2)).toFixed(2)," ر.س"]})]}),e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsx("button",{className:"btn-secondary",onClick:()=>{if(o.realpay){m(s=>({...s,realpay:!1,review:!0}));try{document.querySelector(".checkout-summary")?.scrollIntoView({behavior:"smooth",block:"start"})}catch{}return}if(o.review){m(s=>({...s,review:!1,payment:!0}));try{document.querySelector(`button[onClick*="toggle('payment')"]`).scrollIntoView({behavior:"smooth",block:"start"})}catch{}return}if(o.payment){m(s=>({...s,payment:!1,address:!0}));try{document.querySelector(`button[onClick*="toggle('address')"]`).scrollIntoView({behavior:"smooth",block:"start"})}catch{}return}},children:"رجوع"}),e.jsx("button",{className:"btn-primary flex-1",onClick:async()=>{if(o.address){if(B()){m(s=>({...s,address:!1,payment:!0}));try{document.querySelector(`button[onClick*="toggle('payment')"]`).scrollIntoView({behavior:"smooth",block:"start"})}catch{}}else{const t=["name","email","city","line1","phone"].find(a=>!!i[a]);if(t){const a=document.getElementById(`shipping-${t==="line1"?"address":t}`);if(a&&typeof a.focus=="function"){a.focus();try{a.classList.add("field-flash"),setTimeout(()=>a.classList.remove("field-flash"),1e3)}catch{}}}}return}if(o.payment){try{await F(),m(s=>({...s,payment:!1,review:!0}));try{document.querySelector(".checkout-summary")?.scrollIntoView({behavior:"smooth",block:"start"})}catch{}}catch{}return}if(o.review){m(s=>({...s,realpay:!0}));try{document.querySelector("div.mt-10.border.rounded.overflow-hidden")?.scrollIntoView({behavior:"smooth",block:"start"})}catch{}return}if(o.realpay){p==="cod"&&H();return}},children:"متابعة"})]})]})})]})};export{Ze as default};
