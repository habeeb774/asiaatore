import{r as m,j as e,aq as k,ar as S,as as v}from"./vendor.react-BIXKTxlu.js";import{s as y,t as f,g as b,f as w,v as T}from"./index-B9WgXUd4.js";import{D as A}from"./DataTable-CmXR19l9.js";import{D,C as E}from"./ConfirmModal-CBQLnJ0u.js";import{o as O}from"./invoiceService-DtD4X6Tr.js";import"./vendor-CKneRQof.js";import"./vendor.router-BdFOcp8q.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.tanstack-K6OTystZ.js";import"./vendor.leaflet-Dl6I9sMh.js";/* empty css                     */const z=({order:n,onShipmentUpdate:x})=>{const[l,i]=m.useState(!1),[g,d]=m.useState(null),c=y(),t=n.shipments?.find(a=>a.provider==="smsa"),u=async()=>{i(!0);try{const a=await b.request("post","/shipping/smsa/create",{data:{orderId:n.id}});x({...n,shipments:[...n.shipments||[],a],status:"SHIPPED"}),c.success("تم إنشاء الشحنة بنجاح!",`رقم التتبع: ${a.trackingNumber}`)}catch(a){c.error("فشل إنشاء الشحنة",a.message)}finally{i(!1)}},o=async()=>{if(t){i(!0);try{const a=await b.request("get",`/shipping/smsa/track/${t.trackingNumber}`);d(a),c.info("تم تحديث حالة الشحنة.")}catch(a){c.error("فشل تتبع الشحنة",a.message)}finally{i(!1)}}},h=async()=>{if(!(!t||!window.confirm("هل أنت متأكد من رغبتك في إلغاء هذه الشحنة؟"))){i(!0);try{await b.request("post","/shipping/smsa/cancel",{data:{trackingNumber:t.trackingNumber}}),x({...n,status:"CANCELLED",shipments:n.shipments.filter(a=>a.trackingNumber!==t.trackingNumber)}),c.success("تم إلغاء الشحنة بنجاح.")}catch(a){c.error("فشل إلغاء الشحنة",a.message)}finally{i(!1)}}};return e.jsxs("div",{className:"p-4 my-4 bg-slate-50 border rounded-lg",children:[e.jsxs("h4",{className:"font-bold mb-4 flex items-center gap-2",children:[e.jsx(k,{size:18}),"إدارة الشحن (SMSA)"]}),t?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"الحالة:"})," ",e.jsx("span",{className:"font-mono bg-slate-200 px-2 py-1 rounded",children:n.status})]}),e.jsxs("p",{className:"text-sm",children:[e.jsx("strong",{children:"رقم التتبع:"}),e.jsx("a",{href:`https://smsaexpress.com/trackingdetails?tracknumbers=${t.trackingNumber}`,target:"_blank",rel:"noopener noreferrer",className:"font-mono text-blue-600 hover:underline mr-2",children:t.trackingNumber})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsxs(f,{variant:"outline",size:"sm",onClick:o,disabled:l,children:[e.jsx(S,{size:14,className:"mr-2"}),"تتبع الشحنة"]}),e.jsxs(f,{variant:"destructive",size:"sm",onClick:h,disabled:l,children:[e.jsx(v,{size:14,className:"mr-2"}),"إلغاء الشحنة"]})]}),g&&e.jsx("div",{className:"mt-4 p-3 bg-white border rounded-md text-xs",children:e.jsx("pre",{children:JSON.stringify(g,null,2)})})]}):e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-600 mb-4",children:"لا توجد معلومات شحن لهذا الطلب. قم بإنشاء شحنة جديدة."}),e.jsx(f,{onClick:u,disabled:l,children:l?"جارٍ الإنشاء...":"إنشاء شحنة سمسا"})]})]})};function H(){const{orders:n=[],refresh:x,updateOrder:l}=w()||{},[i,g]=m.useState(""),[d,c]=m.useState(()=>new Set),[t,u]=m.useState(null),[o,h]=m.useState(null),a=m.useMemo(()=>{const s=i.trim().toLowerCase();return(n||[]).filter(r=>!s||String(r.id).includes(s)||(r.customerName||"").toLowerCase().includes(s))},[n,i]),j=m.useCallback(s=>{l&&l(s),t?.id===s.id&&u(s)},[l,t]),N=[{id:"sel",header:e.jsx("input",{type:"checkbox",onChange:s=>{const r=new Set;s.target.checked&&a.forEach(p=>r.add(p.id)),c(r)},checked:a.length>0&&a.every(s=>d.has(s.id)),"aria-label":"Select all"}),cell:s=>e.jsx("input",{type:"checkbox",checked:d.has(s.id),onChange:r=>{const p=new Set(d);r.target.checked?p.add(s.id):p.delete(s.id),c(p)},"aria-label":`Select order ${s.id}`}),width:"48px"},{header:"Order",accessorKey:"id",width:"100px"},{header:"Customer",cell:s=>s.customerName||s.user?.name||"-",width:"30%"},{header:"Total",cell:s=>`${(s.grandTotal??s.total??0).toFixed(2)} SAR`},{header:"Status",accessorKey:"status"},{header:"Created",cell:s=>new Date(s.createdAt).toLocaleString()},{id:"actions",header:"Actions",cell:s=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:"btn-outline btn-xs",onClick:r=>{r.stopPropagation(),u(s)},children:"Details"}),e.jsx("button",{className:"btn-outline btn-xs",onClick:r=>{r.stopPropagation(),O(s.id).catch(p=>alert(p.message))},children:"Invoice"})]})}],C=e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"border rounded px-3 py-1 text-sm",placeholder:"بحث بالرقم/العميل",value:i,onChange:s=>g(s.target.value)}),e.jsx("button",{className:"btn-outline",onClick:x,children:"تحديث"}),d.size>0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-primary",onClick:()=>h({action:"markShipped",count:d.size}),children:"تحديث الحالة"}),e.jsx("button",{className:"btn-outline",onClick:()=>h({action:"exportCsv",count:d.size}),children:"تصدير CSV"})]})]});return e.jsxs(T,{title:"الطلبات",topbar:C,children:[e.jsx(A,{columns:N,data:a,onRowClick:s=>u(s)}),e.jsx(D,{open:!!t,onClose:()=>u(null),title:t?`Order #${t.id}`:"",children:t&&e.jsxs("div",{className:"space-y-3 text-sm p-4",children:[e.jsx("div",{className:"font-semibold text-base",children:"Customer"}),e.jsx("div",{children:t.customerName||"-"}),e.jsx("div",{className:"font-semibold text-base mt-4",children:"Items"}),e.jsx("ul",{className:"list-disc list-inside bg-slate-50 p-3 rounded-md",children:(t.items||[]).map(s=>e.jsxs("li",{children:[s.name||s.productName," × ",s.quantity," — ",(s.total||0).toFixed(2)," SAR"]},s.id))}),e.jsx("div",{className:"font-semibold text-base mt-4",children:"Totals"}),e.jsxs("div",{className:"bg-slate-50 p-3 rounded-md",children:["Total: ",e.jsxs("span",{className:"font-bold",children:[(t.grandTotal??t.total??0).toFixed(2)," SAR"]})]}),e.jsx(z,{order:t,onShipmentUpdate:j})]})}),e.jsx(E,{open:!!o,onClose:()=>h(null),danger:o?.action==="markShipped",title:o?.action==="exportCsv"?"Export CSV":"Update Status",message:o?o.action==="exportCsv"?`Export ${o.count} orders to CSV?`:`Change status for ${o.count} orders?`:"",confirmText:o?.action==="exportCsv"?"Export":"Update",onConfirm:()=>{c(new Set)}})]})}export{H as default};
