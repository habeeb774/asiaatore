import{a7 as $,r,j as e}from"./vendor.react-C0fmYGW5.js";import{g as U,f as C}from"./index-Df3LzoMm.js";import{i as S,u as R}from"./paymentService-BEp1tRVd.js";import"./vendor-CF_-ATCh.js";import"./vendor.router-2GzHiivc.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.tanstack-K6OTystZ.js";import"./vendor.leaflet-U7UpOlxs.js";/* empty css                     */function F(i){return`/api/orders/${i}/invoice`}const J=()=>{const{id:i}=$(),{getOrderById:m,updateOrderStatus:j,mergeOrder:l}=U()||{},{user:v}=C()||{},[k,N]=r.useState(null),c=m?m(i):null,t=c||k,[_,x]=r.useState(!1),[d,h]=r.useState(!1),[u,p]=r.useState(null),[O,B]=r.useState(null),[y,g]=r.useState(!1);t?.paymentMethod==="bank"||t?.status,r.useEffect(()=>{!c&&i&&(async()=>{try{const a=await fetch(`/api/orders/${i}`);if(a.ok){const s=await a.json();s?.ok&&s.order&&N(s.order)}}catch{}})()},[c,i]);async function b(){if(!(t.paymentMethod==="bank"||t.status==="pending_bank_review"))try{const s=(await S({orderId:t.id}))?.bank?.reference,o={...t,paymentMethod:"bank",status:"pending_bank_review",paymentMeta:{...t.paymentMeta||{},bank:{reference:s}}};l&&l(o)}catch(a){p("فشل بدء التحويل البنكي: "+a.message)}}async function f(a){const s=a.target.files?.[0];if(s){p(null),h(!0);try{await b();const o=await R({orderId:t.id,file:s});if(o?.receiptUrl){const M={...t,paymentMethod:"bank",status:"pending_bank_review",paymentMeta:{...t.paymentMeta||{},bank:{...t.paymentMeta?.bank||{},receiptUrl:o.receiptUrl}}};l&&l(M)}}catch(o){p(o.message)}finally{h(!1)}}}if(!t)return e.jsx("div",{className:"container-custom px-4 py-12",children:"الطلب غير موجود أو قيد التحميل..."});const w=t.grandTotal!=null?t.grandTotal:t.total||(t.items||[]).reduce((a,s)=>a+(s.price||0)*(s.quantity||1),0),n=t?.paymentMeta?.address||null,I=n?[n.name,n.email,`${n.country||""}${n.country&&n.city?" - ":""}${n.city||""}`,n.line1,n.phone].filter(Boolean).join(`
`):"";return e.jsxs("div",{className:"container-custom px-4 py-8",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4",children:["تفاصيل الطلب #",t.id]}),e.jsxs("div",{className:"mb-4 space-y-1",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["المستخدم: ",t.userId]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["تاريخ: ",new Date(t.createdAt).toLocaleString()]}),e.jsxs("div",{className:"text-sm flex items-center gap-2",children:["الحالة: ",e.jsx("strong",{className:"inline-block px-2 py-0.5 rounded bg-slate-100 text-slate-700 text-xs",children:t.status})," ",_&&e.jsx("span",{className:"text-xs opacity-60",children:"...جاري الحفظ"})]}),e.jsxs("div",{className:"text-sm",children:["طريقة الدفع: ",t.paymentMethod||"غير محدد"]}),e.jsxs("div",{className:"pt-1 flex items-center gap-2 flex-wrap",children:[e.jsx("a",{href:`/api/orders/${t.id}/invoice?token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",className:"btn-secondary px-3 py-1 text-xs",children:"عرض الفاتورة (HTML)"}),e.jsx("a",{href:`/api/orders/${t.id}/invoice.pdf?token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",className:"btn-secondary px-3 py-1 text-xs",children:"PDF A4"}),e.jsx("a",{href:`/api/orders/${t.id}/invoice.pdf?paper=thermal80&token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",className:"btn-secondary px-3 py-1 text-xs",children:"PDF حراري 80mm"}),e.jsx("a",{href:`/api/orders/${t.id}/invoice?paper=thermal80&auto=1&token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",className:"btn-primary px-3 py-1 text-xs",children:"طباعة حرارية الآن"})]}),n&&e.jsxs("div",{className:"mt-3 p-3 border rounded bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"عنوان الشحن"}),e.jsx("button",{type:"button",onClick:()=>{try{navigator.clipboard.writeText(I)}catch{}},className:"text-xs text-blue-700 hover:underline",children:"نسخ"})]}),e.jsxs("div",{className:"text-sm leading-relaxed",children:[n.name&&e.jsx("div",{children:n.name}),n.email&&e.jsx("div",{className:"text-gray-600",children:n.email}),e.jsxs("div",{children:[n.country," ",n.city?e.jsxs(e.Fragment,{children:["- ",n.city]}):null]}),n.line1&&e.jsx("div",{children:n.line1}),n.phone&&e.jsx("div",{className:"text-gray-700",children:n.phone})]})]}),e.jsxs("div",{className:"mt-4 p-3 border rounded bg-gray-50 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:"التحويل البنكي"}),t.paymentMethod!=="bank"&&t.status==="pending"&&e.jsx("button",{type:"button",onClick:b,className:"btn-secondary px-3 py-1 text-xs",children:"بدء التحويل"})]}),t.paymentMethod!=="bank"&&t.status!=="pending"&&t.status!=="pending_bank_review"&&e.jsxs("div",{className:"text-xs text-amber-700 bg-amber-50 border border-amber-200 p-2 rounded",children:["لا يمكن رفع إيصال الآن. الحالة الحالية: ",e.jsx("strong",{children:t.status}),". الرفع متاح فقط عندما تكون الحالة (pending) لتبدأ التحويل أو (pending_bank_review) بعد البدء."]}),(t.paymentMethod==="bank"||t.status==="pending_bank_review")&&e.jsxs(e.Fragment,{children:[t.paymentMeta?.bank?.reference&&e.jsxs("div",{className:"text-xs",children:["الرقم المرجعي: ",e.jsx("span",{className:"font-mono",children:t.paymentMeta.bank.reference})]}),e.jsx("div",{className:"text-xs text-gray-600 leading-relaxed",children:t.paymentMeta?.bank?.receiptUrl?"تم رفع الإيصال، بانتظار المراجعة.":"قم برفع إيصال التحويل البنكي (صورة أو PDF حتى 5MB) ليتم مراجعته."}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap text-xs",children:[t.paymentMeta?.bank?.receiptUrl?e.jsxs(e.Fragment,{children:[e.jsx("a",{href:t.paymentMeta.bank.receiptUrl,target:"_blank",rel:"noopener",className:"text-blue-600 underline",children:"عرض الإيصال"}),!y&&e.jsx("button",{type:"button",onClick:()=>g(!0),className:"btn-secondary px-2 py-1",children:"استبدال الإيصال"}),y&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("input",{type:"file",accept:"image/*,.pdf",disabled:d,onChange:f}),e.jsx("button",{type:"button",onClick:()=>g(!1),className:"text-gray-500 hover:text-gray-700",children:"إلغاء"})]})]}):e.jsx("input",{type:"file",accept:"image/*,.pdf",disabled:d,onChange:f}),d&&e.jsx("span",{className:"opacity-70",children:"جاري الرفع..."}),u&&e.jsxs("span",{className:"text-red-600",children:["فشل: ",u]})]})]})]})]}),e.jsx("div",{className:"mb-6 space-y-3",children:(t.items||[]).map(a=>{const s=typeof a.name=="string"?a.name:a.name?.ar||a.name?.en||a.productId;return e.jsxs("div",{className:"flex items-center gap-4 p-3 border rounded",children:[a.image&&e.jsx("img",{src:a.image,alt:s,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold",children:s}),e.jsxs("div",{className:"text-sm text-gray-600",children:[a.price," ر.س × ",a.quantity||1]})]}),e.jsxs("div",{className:"font-bold",children:[(a.price*(a.quantity||1)).toFixed(2)," ر.س"]})]},a.id)})}),e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsx("div",{children:v?.role==="admin"&&e.jsxs("select",{value:t.status,onChange:async a=>{x(!0),await j(t.id,a.target.value),x(!1)},children:[e.jsx("option",{value:"pending",children:"قيد الانتظار"}),e.jsx("option",{value:"pending_bank_review",children:"مراجعة تحويل بنكي"}),e.jsx("option",{value:"processing",children:"قيد المعالجة"}),e.jsx("option",{value:"shipped",children:"تم الشحن"}),e.jsx("option",{value:"delivered",children:"تم التوصيل"}),e.jsx("option",{value:"cancelled",children:"ملغي"})]})}),e.jsxs("div",{className:"ml-auto flex items-center gap-4",children:[e.jsx("button",{className:"btn-secondary",onClick:()=>window.open(F(t.id)+`?token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,"_blank"),children:"عرض الفاتورة"}),e.jsx("a",{className:"btn-secondary",href:`/api/orders/${t.id}/invoice.pdf?token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",children:"PDF A4"}),e.jsx("a",{className:"btn-secondary",href:`/api/orders/${t.id}/invoice.pdf?paper=thermal80&token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",children:"PDF حراري 80mm"}),e.jsx("button",{className:"btn-primary",onClick:()=>window.open(`/api/orders/${t.id}/invoice?paper=thermal80&auto=1&token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,"_blank"),children:"طباعة حرارية"}),e.jsxs("div",{className:"text-lg font-bold",children:["الإجمالي: ",w," ر.س"]})]})]})]})};export{J as default};
