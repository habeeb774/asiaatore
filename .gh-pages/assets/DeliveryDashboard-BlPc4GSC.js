import{b as q,r as s,j as e}from"./vendor.react-BIXKTxlu.js";import{e as Q,g as o,B as d}from"./index-B9WgXUd4.js";import{B as I}from"./Badge-BxiMcqhp.js";import{R as U}from"./RoutePlanner-BZRRew1u.js";/* empty css                  */import"./vendor-CKneRQof.js";import"./vendor.router-BdFOcp8q.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.tanstack-K6OTystZ.js";import"./vendor.leaflet-Dl6I9sMh.js";/* empty css                     */const V=({className:a="",size:l=20})=>e.jsxs("svg",{className:a,width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("path",{d:"M1 3h13v13H1z",stroke:"currentColor",strokeWidth:"1.2",strokeLinejoin:"round",strokeLinecap:"round"}),e.jsx("path",{d:"M14 8h4l3 3v5",stroke:"currentColor",strokeWidth:"1.2",strokeLinejoin:"round",strokeLinecap:"round"}),e.jsx("circle",{cx:"7",cy:"18",r:"1.5",fill:"currentColor"}),e.jsx("circle",{cx:"19",cy:"18",r:"1.5",fill:"currentColor"})]}),$=({className:a="",size:l=18})=>e.jsxs("svg",{className:a,width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("path",{d:"M21 10a9 9 0 1 0-3 6.7L21 10z",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M21 3v7h-7",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round",strokeLinejoin:"round"})]}),X=({className:a="",size:l=16})=>e.jsxs("svg",{className:a,width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("path",{d:"M9 12l2 2 4-4",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"currentColor",strokeWidth:"1.2"})]}),Y=({className:a="",size:l=16})=>e.jsxs("svg",{className:a,width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("circle",{cx:"12",cy:"12",r:"9",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M12 8v5",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"}),e.jsx("path",{d:"M12 16h.01",stroke:"currentColor",strokeWidth:"1.4",strokeLinecap:"round"})]}),Z=({className:a="",size:l=14})=>e.jsxs("svg",{className:a,width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M14 2v6h6",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M16 13c.5-1 2-1 3 0s2 1 3 0",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round",strokeLinejoin:"round"})]}),ee=({className:a="",size:l=14})=>e.jsxs("svg",{className:a,width:l,height:l,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:[e.jsx("circle",{cx:"7",cy:"11",r:"2",stroke:"currentColor",strokeWidth:"1.2"}),e.jsx("path",{d:"M9 11l9 9",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round"}),e.jsx("path",{d:"M20 20v-3",stroke:"currentColor",strokeWidth:"1.2",strokeLinecap:"round"})]});function xe(){const{user:a}=Q()||{},l=q(),[N,M]=s.useState([]),[F,B]=s.useState(!0),[O,u]=s.useState(null),[c,f]=s.useState(null),[C,P]=s.useState(""),[L,_]=s.useState(null),[j,D]=s.useState(""),[S,H]=s.useState(null),[p,A]=s.useState([]),[m,z]=s.useState("active"),[v,T]=s.useState(!1),y=s.useRef(null),W=s.useRef(null),k=s.useRef(null),h=s.useCallback(async()=>{try{B(!0);const r={};v&&(r.pool=1),m!=="active"&&m!=="all"&&(r.status=m);let n=(await o.deliveryList(r))?.orders||[];m==="active"&&(n=n.filter(i=>["accepted","out_for_delivery"].includes(i.deliveryStatus))),M(n),u(null)}catch(r){console.error("fetchOrders error",r),u(r?.response?.data?.message||r?.message||"فشل تحميل الطلبات")}finally{B(!1)}},[v,m]),E=s.useCallback(async()=>{try{const r=await o.deliveryProfileGet();H(r?.profile||r||null)}catch(r){console.warn("fetchProfile",r)}},[]),g=s.useCallback(async(r,t,n=null)=>{try{switch(r){case"accept":await o.deliveryAccept(t);break;case"reject":await o.deliveryReject(t);break;case"start":await o.deliveryStart(t),f(t);break;case"complete":if(L){const i=new FormData;i.append("signature",L),await o.deliverySignature(t,i)}await o.deliveryComplete(t,{}),_(null),f(null);break;case"fail":await o.deliveryFail(t,n?.reason||j||"تعذر التسليم"),f(null);break;case"otp":await o.deliveryOtpConfirm(t,C),P("");break;default:return}await h()}catch(i){console.error(`${r} error`,i),u(`فشل ${r}: ${i?.message||"حدث خطأ"}`)}},[L,C,j,h]),w=s.useCallback(()=>{if(!("geolocation"in navigator)){u("المتصفح لا يدخدم نظام الموقع");return}try{const r=navigator.geolocation.watchPosition(async t=>{const{latitude:n,longitude:i}=t.coords;if(c)try{await o.deliveryLocation(c,{lat:n,lng:i})}catch(x){console.warn("location update failed",x)}},t=>{console.warn("geo error",t),u("فشل في الحصول على الموقع")},{enableHighAccuracy:!0,maximumAge:1e4,timeout:15e3});y.current=r}catch(r){console.warn("startLocationWatch error",r)}},[c]),b=s.useCallback(()=>{y.current!=null&&(navigator.geolocation.clearWatch(y.current),y.current=null)},[]);s.useEffect(()=>{if(a&&["delivery","admin"].includes(a.role)){E(),h(),w(),W.current=setInterval(h,2e4);try{const r=new EventSource("/api/events");k.current=r,r.addEventListener("delivery.updated",t=>{try{const n=JSON.parse(t.data||"{}"),{orderId:i,deliveryStatus:x}=n||{};if(!i)return;M(K=>K.map(R=>R.id===i?{...R,deliveryStatus:x}:R))}catch{}}),r.onerror=()=>{}}catch{}return()=>{if(W.current&&clearInterval(W.current),b(),k.current){try{k.current.close()}catch{}k.current=null}}}},[a,h,E,w,b]),s.useEffect(()=>{c?w():b()},[c,w,b]);function G(r){if(!r)return null;if(r.lat&&r.lng)return{lat:+r.lat,lng:+r.lng};if(r.location&&r.location.lat&&r.location.lng)return{lat:+r.location.lat,lng:+r.location.lng};if(r.deliveryLocation&&r.deliveryLocation.lat&&r.deliveryLocation.lng)return{lat:+r.deliveryLocation.lat,lng:+r.deliveryLocation.lng};if(r.toLat&&r.toLng)return{lat:+r.toLat,lng:+r.toLng};if(r.destination&&r.destination.lat&&r.destination.lng)return{lat:+r.destination.lat,lng:+r.destination.lng};if(r.address&&r.address.lat&&r.address.lng)return{lat:+r.address.lat,lng:+r.address.lng};if(r.coords&&typeof r.coords=="string"){const t=r.coords.split(",").map(n=>n.trim());if(t.length>=2)return{lat:+t[0],lng:+t[1]}}return null}function J(r){if(p.find(x=>x.id===r.id)){A(p.filter(x=>x.id!==r.id));return}const n=G(r);if(!n){u("لا يمكن إضافة هذا الطلب للمسار — لا توجد إحداثيات.");return}const i=r.customer&&(r.customer.name||r.customer.fullName)||r.address&&(r.address.line1||r.address.display)||`#${String(r.id).slice(0,8)}`;A([...p,{id:r.id,lat:n.lat,lng:n.lng,label:i}])}return a?["delivery","admin"].includes(a.role)?e.jsx("div",{className:"min-h-screen p-4",style:{background:"var(--color-bg)"},children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("header",{className:"flex items-center justify-between py-4 mb-4 rounded-lg shadow-sm px-4",style:{background:"var(--color-surface)",border:"1px solid var(--color-border-soft)"},children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{className:"w-6 h-6",style:{color:"var(--color-primary)"}}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",style:{color:"var(--color-text)"},children:"لوحة تحكم الموزع"}),S&&e.jsxs("p",{className:"text-xs mt-0.5",style:{color:"var(--color-text-soft)"},children:["الحالة: ",S?.profile?.status||S?.status||"—"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:r=>T(r.target.checked)}),e.jsx("span",{children:"عرض طلبات Pool"})]}),e.jsxs("select",{value:m,onChange:r=>z(r.target.value),className:"border rounded px-2 py-1",title:"تصفية الحالة",children:[e.jsx("option",{value:"active",children:"نشطة"}),e.jsx("option",{value:"accepted",children:"مقبولة"}),e.jsx("option",{value:"out_for_delivery",children:"خارج للتسليم"}),e.jsx("option",{value:"delivered",children:"تم التسليم"}),e.jsx("option",{value:"failed",children:"تعذر التسليم"}),e.jsx("option",{value:"all",children:"الكل"})]}),e.jsx(d,{onClick:h,children:e.jsx($,{className:"w-4 h-4"})}),e.jsx(d,{onClick:()=>l("/delivery/summary"),children:"ملخص الرحلة"})]})]}),O&&e.jsxs("div",{className:"p-3 mb-4 rounded-lg flex items-center gap-2",style:{background:"rgba(220,38,38,0.08)",border:"1px solid rgba(220,38,38,0.25)",color:"#7f1d1d"},children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:O}),e.jsx("button",{onClick:()=>u(null),className:"ml-auto text-red-500 hover:text-red-700",children:"✕"})]}),e.jsxs("section",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"rounded-lg shadow-sm border p-3",style:{background:"var(--color-surface)",borderColor:"var(--color-border-soft)"},children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"font-semibold",children:"الطلبات"}),e.jsx(I,{color:"neutral",children:N.length})]}),e.jsxs("div",{className:"space-y-2 max-h-[70vh] overflow-auto",children:[F&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"skeleton h-12"}),e.jsx("div",{className:"skeleton h-12"}),e.jsx("div",{className:"skeleton h-12"})]}),!F&&N.length===0&&e.jsx("div",{className:"text-sm text-gray-500",children:"لا توجد طلبات مطابقة للتصفية الحالية"}),N.map(r=>e.jsxs("div",{className:"rounded border p-2",style:c===r.id?{borderColor:"rgba(var(--color-primary-rgb),0.45)",background:"rgba(var(--color-primary-rgb),0.06)"}:{borderColor:"var(--color-border-soft)",background:"var(--color-surface)"},children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"inline-flex items-center gap-2",children:e.jsx("input",{type:"checkbox",checked:!!p.find(t=>t.id===r.id),onChange:()=>J(r)})}),e.jsxs("button",{className:"text-right",onClick:()=>f(r.id),children:[e.jsxs("div",{className:"font-semibold",style:{color:"var(--color-text)"},children:["#",r.id.slice(0,8),"..."]}),e.jsxs("div",{className:"text-xs",style:{color:"var(--color-text-faint)"},children:["الحالة: ",r.deliveryStatus]})]})]}),e.jsx(I,{color:r.deliveryStatus==="out_for_delivery"?"info":r.deliveryStatus==="accepted"?"warning":r.deliveryStatus==="delivered"?"success":r.deliveryStatus==="failed"?"danger":"neutral",children:r.deliveryStatus})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[v&&e.jsx(d,{size:"sm",onClick:()=>g("accept",r.id),children:"استلام"}),!v&&r.deliveryStatus==="accepted"&&e.jsx(d,{size:"sm",onClick:()=>g("start",r.id),children:"بدء التسليم"}),!v&&r.deliveryStatus==="out_for_delivery"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"text-xs cursor-pointer inline-flex items-center gap-2",children:[e.jsx("input",{type:"file",className:"hidden",onChange:t=>_(t.target.files?.[0]||null)}),e.jsxs("span",{className:"px-2 py-1 border rounded inline-flex items-center gap-1",children:[e.jsx(Z,{className:"w-4 h-4"})," توقيع"]})]}),e.jsxs(d,{size:"sm",variant:"success",onClick:()=>g("complete",r.id),children:[e.jsx(X,{className:"w-4 h-4"})," تم التسليم"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 text-xs",placeholder:"سبب الفشل",value:j,onChange:t=>D(t.target.value)}),e.jsx(d,{size:"sm",variant:"destructive",onClick:()=>g("fail",r.id,{reason:j||"تعذر الوصول"}),children:"تعذر التسليم"})]})]}),r.deliveryStatus!=="delivered"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 text-xs",placeholder:"OTP",value:C,onChange:t=>P(t.target.value)}),e.jsxs(d,{size:"sm",variant:"outline",onClick:()=>g("otp",r.id),children:[e.jsx(ee,{className:"w-4 h-4"})," تحقق"]})]})]})]},r.id))]})]}),e.jsxs("div",{className:"rounded-lg shadow-sm border p-4",style:{background:"var(--color-surface)",borderColor:"var(--color-border-soft)"},children:[e.jsx("h3",{className:"font-semibold mb-2",children:"خريطة وتخطيط المسار"}),e.jsx(U,{stops:p}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"تفاصيل الطلب"}),!c&&e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-faint)"},children:"اختر طلباً من القائمة لعرض التفاصيل"}),c&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm",style:{color:"var(--color-text)"},children:["المعرف: ",e.jsx("span",{className:"font-mono",children:c})]}),e.jsx("div",{className:"text-xs",style:{color:"var(--color-text-faint)"},children:"استخدم الخريطة أعلاه لعرض الطريق الحي"}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs(d,{onClick:h,size:"sm",variant:"outline",children:[e.jsx($,{className:"w-4 h-4"})," تحديث"]})})]})]})]})]})]})}):e.jsx("div",{className:"min-h-screen p-4 bg-gray-50",children:"غير مصرح بالوصول"}):e.jsx("div",{className:"min-h-screen p-4 bg-gray-50",children:"يجب تسجيل الدخول"})}export{xe as default};
