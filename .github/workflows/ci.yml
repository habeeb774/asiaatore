name: CI â€” verify, build, tests, lighthouse, images

on:
  push:
    branches: [ main, master, develop, 'rescue/**' ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install workspace dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Verify (lint, typecheck, build, prisma validate)
        run: npm run -s ci:verify

  test-client:
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install client deps
        working-directory: ./client
        run: npm ci

      - name: Run vitest (unit tests)
        working-directory: ./client
        run: npm run test --if-present

  build-and-lighthouse:
    runs-on: ubuntu-latest
    needs: test-client
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Lint (client)
        working-directory: ./client
        run: npm run lint --if-present

      - name: Build client
        working-directory: ./client
        run: npm run build --if-present

      - name: Start a static server for the build (background)
        run: |
          npm install -g http-server --no-progress
          npx http-server ./client/dist -p 8080 >/tmp/http-server.log 2>&1 &

      - name: Wait for server to be ready
        run: |
          for i in {1..15}; do
            if curl --output /dev/null --silent --head --fail http://127.0.0.1:8080; then
              echo "server ready"; break;
            fi;
            echo "waiting for server... ($i)";
            sleep 2;
          done

      - name: Run Lighthouse audit (page-level)
        env:
          LH_PORT: 8080
        run: |
          mkdir -p reports
          npx -y lighthouse http://127.0.0.1:8080 --output=json --output-path=reports/lighthouse.json --chrome-flags='--no-sandbox --headless'

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: reports/lighthouse.json

  images:
    runs-on: ubuntu-latest
    needs: build-and-lighthouse
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install client deps
        working-directory: ./client
        run: npm ci

      - name: Convert images to WebP (client + uploads)
        working-directory: ./client
        run: |
          # run converter (script supports flags like --quality)
          node scripts/convert-images-to-webp.js --quality=80 || true

      - name: Upload converted images as artifact
        uses: actions/upload-artifact@v4
        with:
          name: converted-webp
          path: |
            client/**/*.webp
            uploads/**/*.webp

  publish-images:
    runs-on: ubuntu-latest
    needs: images
    # Only run publish when S3 credentials and bucket are configured in Secrets
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install AWS CLI
        run: |
          python -m pip install --upgrade pip
          pip install awscli

      - name: Configure AWS credentials
        if: ${{ secrets.AWS_S3_BUCKET != '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Sync converted images to S3 bucket
        if: ${{ secrets.AWS_S3_BUCKET != '' && secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '' }}
        env:
          S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          S3_PREFIX: ${{ secrets.AWS_S3_PREFIX || 'images/webp' }}
          S3_ENDPOINT: ${{ secrets.AWS_S3_ENDPOINT || '' }}
        run: |
          # Prefer client webp, then uploads
          echo "Syncing client webp files to s3://$S3_BUCKET/$S3_PREFIX/client/"
          if [ -d client ]; then
            aws s3 sync client/ s3://$S3_BUCKET/$S3_PREFIX/client/ --exclude "*" --include "**/*.webp" --acl public-read
          fi
          if [ -d uploads ]; then
            echo "Syncing uploads webp files to s3://$S3_BUCKET/$S3_PREFIX/uploads/"
            aws s3 sync uploads/ s3://$S3_BUCKET/$S3_PREFIX/uploads/ --exclude "*" --include "**/*.webp" --acl public-read
          fi
          echo "Upload complete"
