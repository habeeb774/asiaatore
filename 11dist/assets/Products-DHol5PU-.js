import{E as e,N as t,P as n,T as r,_ as i,a,c as o,d as s,f as c,g as l,h as u,i as d,j as f,k as p,l as m,m as h,n as g,o as _,p as v,r as y,s as b,t as x,u as S,w as C}from"./index-HsKwDOAa.js";import{t as w}from"./ProductFilters-4vrLVmQF.js";import{t as T}from"./ProductGrid-DH-NILNo.js";var E=class extends l{constructor(e,t){super(),this.options=t,this.#client=e,this.#selectError=null,this.#currentThenable=d(),this.bindMethods(),this.setOptions(t)}#client;#currentQuery=void 0;#currentQueryInitialState=void 0;#currentResult=void 0;#currentResultState;#currentResultOptions;#currentThenable;#selectError;#selectFn;#selectResult;#lastQueryWithDefinedData;#staleTimeoutId;#refetchIntervalId;#currentRefetchInterval;#trackedProps=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#currentQuery.addObserver(this),O(this.#currentQuery,this.options)?this.#executeFetch():this.updateResult(),this.#updateTimers())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return k(this.#currentQuery,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return k(this.#currentQuery,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#clearStaleTimeout(),this.#clearRefetchInterval(),this.#currentQuery.removeObserver(this)}setOptions(e){let t=this.options,n=this.#currentQuery;if(this.options=this.#client.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!=`boolean`&&typeof this.options.enabled!=`function`&&typeof S(this.options.enabled,this.#currentQuery)!=`boolean`)throw Error(`Expected enabled to be a boolean or a callback that returns a boolean`);this.#updateQuery(),this.#currentQuery.setOptions(this.options),t._defaulted&&!c(this.options,t)&&this.#client.getQueryCache().notify({type:`observerOptionsUpdated`,query:this.#currentQuery,observer:this});let r=this.hasListeners();r&&A(this.#currentQuery,n,this.options,t)&&this.#executeFetch(),this.updateResult(),r&&(this.#currentQuery!==n||S(this.options.enabled,this.#currentQuery)!==S(t.enabled,this.#currentQuery)||s(this.options.staleTime,this.#currentQuery)!==s(t.staleTime,this.#currentQuery))&&this.#updateStaleTimeout();let i=this.#computeRefetchInterval();r&&(this.#currentQuery!==n||S(this.options.enabled,this.#currentQuery)!==S(t.enabled,this.#currentQuery)||i!==this.#currentRefetchInterval)&&this.#updateRefetchInterval(i)}getOptimisticResult(e){let t=this.#client.getQueryCache().build(this.#client,e),n=this.createResult(t,e);return M(this,n)&&(this.#currentResult=n,this.#currentResultOptions=this.options,this.#currentResultState=this.#currentQuery.state),n}getCurrentResult(){return this.#currentResult}trackResult(e,t){return new Proxy(e,{get:(e,n)=>(this.trackProp(n),t?.(n),n===`promise`&&!this.options.experimental_prefetchInRender&&this.#currentThenable.status===`pending`&&this.#currentThenable.reject(Error(`experimental_prefetchInRender feature flag is not enabled`)),Reflect.get(e,n))})}trackProp(e){this.#trackedProps.add(e)}getCurrentQuery(){return this.#currentQuery}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){let t=this.#client.defaultQueryOptions(e),n=this.#client.getQueryCache().build(this.#client,t);return n.fetch().then(()=>this.createResult(n,t))}fetch(e){return this.#executeFetch({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#currentResult))}#executeFetch(e){this.#updateQuery();let t=this.#currentQuery.fetch(this.options,e);return e?.throwOnError||(t=t.catch(o)),t}#updateStaleTimeout(){this.#clearStaleTimeout();let e=s(this.options.staleTime,this.#currentQuery);if(_||this.#currentResult.isStale||!b(e))return;let t=h(this.#currentResult.dataUpdatedAt,e)+1;this.#staleTimeoutId=u.setTimeout(()=>{this.#currentResult.isStale||this.updateResult()},t)}#computeRefetchInterval(){return(typeof this.options.refetchInterval==`function`?this.options.refetchInterval(this.#currentQuery):this.options.refetchInterval)??!1}#updateRefetchInterval(e){this.#clearRefetchInterval(),this.#currentRefetchInterval=e,!(_||S(this.options.enabled,this.#currentQuery)===!1||!b(this.#currentRefetchInterval)||this.#currentRefetchInterval===0)&&(this.#refetchIntervalId=u.setInterval(()=>{(this.options.refetchIntervalInBackground||a.isFocused())&&this.#executeFetch()},this.#currentRefetchInterval))}#updateTimers(){this.#updateStaleTimeout(),this.#updateRefetchInterval(this.#computeRefetchInterval())}#clearStaleTimeout(){this.#staleTimeoutId&&=(u.clearTimeout(this.#staleTimeoutId),void 0)}#clearRefetchInterval(){this.#refetchIntervalId&&=(u.clearInterval(this.#refetchIntervalId),void 0)}createResult(e,t){let n=this.#currentQuery,r=this.options,i=this.#currentResult,a=this.#currentResultState,o=this.#currentResultOptions,s=e===n?this.#currentQueryInitialState:e.state,{state:c}=e,l={...c},u=!1,f;if(t._optimisticResults){let i=this.hasListeners(),a=!i&&O(e,t),o=i&&A(e,n,t,r);(a||o)&&(l={...l,...g(c.data,e.options)}),t._optimisticResults===`isRestoring`&&(l.fetchStatus=`idle`)}let{error:p,errorUpdatedAt:h,status:_}=l;f=l.data;let v=!1;if(t.placeholderData!==void 0&&f===void 0&&_===`pending`){let e;i?.isPlaceholderData&&t.placeholderData===o?.placeholderData?(e=i.data,v=!0):e=typeof t.placeholderData==`function`?t.placeholderData(this.#lastQueryWithDefinedData?.state.data,this.#lastQueryWithDefinedData):t.placeholderData,e!==void 0&&(_=`success`,f=m(i?.data,e,t),u=!0)}if(t.select&&f!==void 0&&!v)if(i&&f===a?.data&&t.select===this.#selectFn)f=this.#selectResult;else try{this.#selectFn=t.select,f=t.select(f),f=m(i?.data,f,t),this.#selectResult=f,this.#selectError=null}catch(e){this.#selectError=e}this.#selectError&&(p=this.#selectError,f=this.#selectResult,h=Date.now(),_=`error`);let y=l.fetchStatus===`fetching`,b=_===`pending`,x=_===`error`,C=b&&y,w=f!==void 0,T={status:_,fetchStatus:l.fetchStatus,isPending:b,isSuccess:_===`success`,isError:x,isInitialLoading:C,isLoading:C,data:f,dataUpdatedAt:l.dataUpdatedAt,error:p,errorUpdatedAt:h,failureCount:l.fetchFailureCount,failureReason:l.fetchFailureReason,errorUpdateCount:l.errorUpdateCount,isFetched:l.dataUpdateCount>0||l.errorUpdateCount>0,isFetchedAfterMount:l.dataUpdateCount>s.dataUpdateCount||l.errorUpdateCount>s.errorUpdateCount,isFetching:y,isRefetching:y&&!b,isLoadingError:x&&!w,isPaused:l.fetchStatus===`paused`,isPlaceholderData:u,isRefetchError:x&&w,isStale:j(e,t),refetch:this.refetch,promise:this.#currentThenable,isEnabled:S(t.enabled,e)!==!1};if(this.options.experimental_prefetchInRender){let t=e=>{T.status===`error`?e.reject(T.error):T.data!==void 0&&e.resolve(T.data)},r=()=>{let e=this.#currentThenable=T.promise=d();t(e)},i=this.#currentThenable;switch(i.status){case`pending`:e.queryHash===n.queryHash&&t(i);break;case`fulfilled`:(T.status===`error`||T.data!==i.value)&&r();break;case`rejected`:(T.status!==`error`||T.error!==i.reason)&&r();break}}return T}updateResult(){let e=this.#currentResult,t=this.createResult(this.#currentQuery,this.options);this.#currentResultState=this.#currentQuery.state,this.#currentResultOptions=this.options,this.#currentResultState.data!==void 0&&(this.#lastQueryWithDefinedData=this.#currentQuery),!c(t,e)&&(this.#currentResult=t,this.#notify({listeners:(()=>{if(!e)return!0;let{notifyOnChangeProps:t}=this.options,n=typeof t==`function`?t():t;if(n===`all`||!n&&!this.#trackedProps.size)return!0;let r=new Set(n??this.#trackedProps);return this.options.throwOnError&&r.add(`error`),Object.keys(this.#currentResult).some(t=>{let n=t;return this.#currentResult[n]!==e[n]&&r.has(n)})})()}))}#updateQuery(){let e=this.#client.getQueryCache().build(this.#client,this.options);if(e===this.#currentQuery)return;let t=this.#currentQuery;this.#currentQuery=e,this.#currentQueryInitialState=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#updateTimers()}#notify(e){y.batch(()=>{e.listeners&&this.listeners.forEach(e=>{e(this.#currentResult)}),this.#client.getQueryCache().notify({query:this.#currentQuery,type:`observerResultsUpdated`})})}};function D(e,t){return S(t.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status===`error`&&t.retryOnMount===!1)}function O(e,t){return D(e,t)||e.state.data!==void 0&&k(e,t,t.refetchOnMount)}function k(e,t,n){if(S(t.enabled,e)!==!1&&s(t.staleTime,e)!==`static`){let r=typeof n==`function`?n(e):n;return r===`always`||r!==!1&&j(e,t)}return!1}function A(e,t,n,r){return(e!==t||S(r.enabled,e)===!1)&&(!n.suspense||e.state.status!==`error`)&&j(e,n)}function j(e,t){return S(t.enabled,e)!==!1&&e.isStaleByTime(s(t.staleTime,e))}function M(e,t){return!c(e.getCurrentResult(),t)}var N=n(t()),P=N.createContext(!1),F=()=>N.useContext(P);P.Provider;var I=n(e());function L(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var R=N.createContext(L()),z=()=>N.useContext(R),B=(e,t)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(t.isReset()||(e.retryOnMount=!1))},V=e=>{N.useEffect(()=>{e.clearReset()},[e])},H=({result:e,errorResetBoundary:t,throwOnError:n,query:r,suspense:i})=>e.isError&&!t.isReset()&&!e.isFetching&&r&&(i&&e.data===void 0||v(n,[e.error,r])),U=e=>{if(e.suspense){let t=1e3,n=e=>e===`static`?e:Math.max(e??t,t),r=e.staleTime;e.staleTime=typeof r==`function`?(...e)=>n(r(...e)):n(r),typeof e.gcTime==`number`&&(e.gcTime=Math.max(e.gcTime,t))}},W=(e,t)=>e.isLoading&&e.isFetching&&!t,G=(e,t)=>e?.suspense&&t.isPending,K=(e,t,n)=>t.fetchOptimistic(e).catch(()=>{n.clearReset()});function q(e,t,n){let r=F(),i=z(),a=x(n),s=a.defaultQueryOptions(e);a.getDefaultOptions().queries?._experimental_beforeQuery?.(s),s._optimisticResults=r?`isRestoring`:`optimistic`,U(s),B(s,i),V(i);let c=!a.getQueryCache().get(s.queryHash),[l]=N.useState(()=>new t(a,s)),u=l.getOptimisticResult(s),d=!r&&e.subscribed!==!1;if(N.useSyncExternalStore(N.useCallback(e=>{let t=d?l.subscribe(y.batchCalls(e)):o;return l.updateResult(),t},[l,d]),()=>l.getCurrentResult(),()=>l.getCurrentResult()),N.useEffect(()=>{l.setOptions(s)},[s,l]),G(s,u))throw K(s,l,i);if(H({result:u,errorResetBoundary:i,throwOnError:s.throwOnError,query:a.getQueryCache().get(s.queryHash),suspense:s.suspense}))throw u.error;return a.getDefaultOptions().queries?._experimental_afterQuery?.(s,u),s.experimental_prefetchInRender&&!_&&W(u,r)&&(c?K(s,l,i):a.getQueryCache().get(s.queryHash)?.promise)?.catch(o).finally(()=>{l.updateResult()}),s.notifyOnChangeProps?u:l.trackResult(u)}function J(e,t){return q(e,E,t)}var Y=`/api`,X=(e={})=>Object.entries(e).filter(([,e])=>e!=null&&e!==``).map(([e,t])=>Array.isArray(t)?t.map(t=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join(`&`):`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join(`&`);async function Z(e,t,{signal:n}={}){let r=t?`?${X(t)}`:``,i=await fetch(`${Y}${e}${r}`,{method:`GET`,credentials:`include`,headers:{Accept:`application/json`},signal:n});if(!i.ok){let e=await i.json().catch(()=>({})),t=Error(e.message||`Request failed: ${i.status}`);throw t.status=i.status,t.body=e,t}return i.json()}var Q=e=>[`products`,{...e}];async function $({queryKey:e,signal:t}){let[,n]=e;return Z(`/products`,n,{signal:t})}function ee(e){return J({queryKey:Q(e),queryFn:$,placeholderData:e=>e})}var te=e=>[`product`,e];async function ne({queryKey:e,signal:t}){let[,n]=e;return Z(`/products/${n}`,void 0,{signal:t})}function re(){let e=x();return t=>e.prefetchQuery({queryKey:te(t),queryFn:ne,staleTime:6e4})}var ie=()=>{let e=f(),{locale:t}=C(),{setting:n}=r()||{},a=t===`ar`?n?.siteNameAr||`متجري`:n?.siteNameEn||`My Store`,o=t===`ar`?`المنتجات | ${a}`:`${a} | Products`,s=(0,N.useMemo)(()=>({q:new URLSearchParams(e.search).get(`q`)||void 0,category:new URLSearchParams(e.search).get(`category`)||void 0}),[e.search]),{data:c,isLoading:l,isFetching:u,error:d}=ee(s);re();let[m,h]=(0,N.useState)({category:``,sort:`new`,min:``,max:``,rating:``,discount:!1,page:1});(0,N.useEffect)(()=>{let e=new URLSearchParams(window.location.search),t={};[`category`,`sort`,`min`,`max`,`rating`,`discount`,`page`].forEach(n=>{e.has(n)&&(t[n]=e.get(n))}),t.discount&&=t.discount===`true`,t.page&&=+t.page||1,Object.keys(t).length&&h(e=>({...e,...t}))},[]),(0,N.useEffect)(()=>{let e=new URLSearchParams;Object.entries(m).forEach(([t,n])=>{n!==``&&n!==!1&&n!=null&&e.set(t,n)});let t=e.toString(),n=window.location.pathname+(t?`?${t}`:``);window.history.replaceState({},``,n)},[m]);let g=(0,N.useMemo)(()=>{let e=(Array.isArray(c)?c:Array.isArray(c?.items)?c.items:[]).slice();return m.category&&(e=e.filter(e=>e.category===m.category)),m.min&&(e=e.filter(e=>+e.price>=+m.min)),m.max&&(e=e.filter(e=>+e.price<=+m.max)),m.rating&&(e=e.filter(e=>(e.rating||0)>=+m.rating)),m.discount&&(e=e.filter(e=>e.oldPrice&&e.oldPrice>e.price)),m.sort===`price-asc`&&e.sort((e,t)=>e.price-+t.price),m.sort===`price-desc`&&e.sort((e,t)=>t.price-+e.price),e},[m,c]),_=Math.max(1,Math.ceil(g.length/12)),v=Math.min(m.page,_),y=g.slice((v-1)*12,v*12);(0,N.useEffect)(()=>{m.page!==v&&h(e=>({...e,page:v}))},[v,m.page]);let b=()=>{let e=[],t=_,n=v,r=t=>e.push(t);if(t<=7)for(let e=1;e<=t;e++)r(e);else{r(1),n-2>2&&r(`…`);let e=Math.max(2,n-2),i=Math.min(t-1,n+2);for(let t=e;t<=i;t++)r(t);n+2<t-1&&r(`…`),r(t)}return e};return l?(0,I.jsx)(`div`,{children:`Loading products…`}):d?(0,I.jsx)(`div`,{children:`Failed to load products.`}):(0,I.jsxs)(`div`,{className:`offers-page catalog-page container-fixed py-8`,children:[(0,I.jsx)(i,{title:o,description:t===`ar`?`المنتجات`:`Products`}),(0,I.jsx)(`nav`,{className:`text-sm text-gray-500 mb-2`,"aria-label":`breadcrumb`,children:(0,I.jsxs)(`ol`,{className:`flex gap-2`,children:[(0,I.jsx)(`li`,{children:(0,I.jsx)(p,{to:`/`,className:`hover:text-primary-red`,children:t===`ar`?`الرئيسية`:`Home`})}),(0,I.jsx)(`li`,{"aria-hidden":!0,children:`›`}),(0,I.jsx)(`li`,{className:`text-gray-700`,children:t===`ar`?`المنتجات`:`Products`})]})}),(0,I.jsx)(`h1`,{className:`page-title`,children:t===`ar`?`المنتجات`:`Products`}),(0,I.jsx)(`div`,{className:`flex items-center justify-between mb-3 text-sm text-gray-600`,children:(0,I.jsx)(`div`,{children:t===`ar`?`عرض ${Math.min(y.length,g.length)} من ${g.length}`:`Showing ${Math.min(y.length,g.length)} of ${g.length}`})}),(0,I.jsx)(w,{state:m,onChange:h}),l&&(0,I.jsx)(`div`,{className:`products-grid`,children:Array.from({length:12}).map((e,t)=>(0,I.jsxs)(`div`,{className:`product-card p-4 animate-pulse`,children:[(0,I.jsx)(`div`,{className:`h-40 bg-slate-200 rounded-lg mb-3`}),(0,I.jsx)(`div`,{className:`h-3 bg-slate-200 rounded w-3/4 mb-2`}),(0,I.jsx)(`div`,{className:`h-3 bg-slate-200 rounded w-1/2 mb-4`}),(0,I.jsx)(`div`,{className:`h-9 bg-slate-200 rounded`})]},t))}),d&&(0,I.jsx)(`p`,{className:`text-red-600 text-sm`,children:d}),!l&&y.length===0&&!d&&(0,I.jsx)(`p`,{children:t===`ar`?`لا توجد نتائج`:`No results`}),!l&&y.length>0&&(0,I.jsx)(T,{products:y}),_>1&&(0,I.jsxs)(`div`,{className:`pagination flex gap-2 justify-center items-center mt-6`,children:[(0,I.jsx)(`button`,{className:`btn-outline px-3 py-1 text-sm disabled:opacity-50`,disabled:v===1,onClick:()=>h(e=>({...e,page:e.page-1})),children:t===`ar`?`السابق`:`Prev`}),b().map((e,t)=>e===`…`?(0,I.jsx)(`span`,{className:`px-2 text-gray-400`,children:`…`},`e${t}`):(0,I.jsx)(`button`,{className:`px-3 py-1 rounded ${e===v?`btn-primary`:`btn-outline text-sm`}`,onClick:()=>h(t=>({...t,page:e})),children:e},e)),(0,I.jsx)(`button`,{className:`btn-outline px-3 py-1 text-sm disabled:opacity-50`,disabled:v===_,onClick:()=>h(e=>({...e,page:e.page+1})),children:t===`ar`?`التالي`:`Next`})]})]})};export{ie as default};