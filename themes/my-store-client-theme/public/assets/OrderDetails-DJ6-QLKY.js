const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-KQCI4LeS.js","assets/vendor.react-BYd2qOD7.js","assets/vendor-B1AZ7KNd.js","assets/vendor.router-BdFOcp8q.js","assets/vendor.i18next-COqwnjR1.js","assets/vendor.zustand-BuMo4m-J.js","assets/vendor.tanstack-K6OTystZ.js","assets/vendor.leaflet-DeoKySpZ.js","assets/index-DZaiRlRO.css","assets/vendor-B1-rhOTE.css"])))=>i.map(i=>d[i]);
import{_ as C}from"./vendor.tanstack-K6OTystZ.js";import{ao as R,r as i,j as e,L as F}from"./vendor.react-BYd2qOD7.js";import{f as O,e as B}from"./index-KQCI4LeS.js";import{i as P,u as A}from"./paymentService-B8T7E9Nq.js";import{o as D}from"./invoiceService-BN1qyjVf.js";import"./vendor-B1AZ7KNd.js";import"./vendor.router-BdFOcp8q.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.leaflet-DeoKySpZ.js";/* empty css                     */import"./apiService-DNwSxsHw.js";function E(l){return`/api/orders/${l}/invoice`}const ee=()=>{const{id:l}=R(),{getOrderById:x,updateOrderStatus:w,mergeOrder:o}=O()||{},{user:h}=B()||{},[I,M]=i.useState(null),c=x?x(l):null,t=c||I,[U,u]=i.useState(!1),[d,y]=i.useState(!1),[g,p]=i.useState(null),[T,L]=i.useState(null),[b,f]=i.useState(!1),[j,v]=i.useState(!1);t?.paymentMethod==="bank"||t?.status,i.useEffect(()=>{!c&&l&&(async()=>{try{const a=await fetch(`/api/orders/${l}`);if(a.ok){const s=await a.json();s?.ok&&s.order&&M(s.order)}}catch{}})()},[c,l]);async function k(){if(!(t.paymentMethod==="bank"||t.status==="pending_bank_review"))try{const s=(await P({orderId:t.id}))?.bank?.reference,r={...t,paymentMethod:"bank",status:"pending_bank_review",paymentMeta:{...t.paymentMeta||{},bank:{reference:s}}};o&&o(r)}catch(a){p("فشل بدء التحويل البنكي: "+a.message)}}async function N(a){const s=a.target.files?.[0];if(s){p(null),y(!0);try{await k();const r=await A({orderId:t.id,file:s});if(r?.receiptUrl){const m={...t,paymentMethod:"bank",status:"pending_bank_review",paymentMeta:{...t.paymentMeta||{},bank:{...t.paymentMeta?.bank||{},receiptUrl:r.receiptUrl}}};o&&o(m)}}catch(r){p(r.message)}finally{y(!1)}}}if(!t)return e.jsx("div",{className:"container-custom px-4 py-12",children:"الطلب غير موجود أو قيد التحميل..."});const $=t.grandTotal!=null?t.grandTotal:t.total||(t.items||[]).reduce((a,s)=>a+(s.price||0)*(s.quantity||1),0),n=t?.paymentMeta?.address||null,S=n?[n.name,n.email,`${n.country||""}${n.country&&n.city?" - ":""}${n.city||""}`,n.line1,n.phone].filter(Boolean).join(`
`):"",_=Array.isArray(t?.shipments)?t.shipments:[];return e.jsxs("div",{className:"container-custom px-4 py-8",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4",children:["تفاصيل الطلب #",t.id]}),e.jsxs("div",{className:"mb-4 space-y-1",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["المستخدم: ",t.userId]}),e.jsxs("div",{className:"text-sm text-gray-600",children:["تاريخ: ",new Date(t.createdAt).toLocaleString()]}),e.jsxs("div",{className:"text-sm flex items-center gap-2",children:["الحالة: ",e.jsx("strong",{className:"inline-block px-2 py-0.5 rounded bg-slate-100 text-slate-700 text-xs",children:t.status})," ",U&&e.jsx("span",{className:"text-xs opacity-60",children:"...جاري الحفظ"})]}),e.jsxs("div",{className:"text-sm",children:["طريقة الدفع: ",t.paymentMethod||"غير محدد"]}),e.jsxs("div",{className:"pt-1 flex items-center gap-2 flex-wrap",children:[e.jsx("a",{href:`/api/orders/${t.id}/invoice?token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",className:"btn-secondary px-3 py-1 text-xs",children:"عرض الفاتورة (HTML)"}),e.jsx("a",{href:`/api/orders/${t.id}/invoice.pdf?token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",className:"btn-secondary px-3 py-1 text-xs",children:"PDF A4"}),e.jsx("a",{href:`/api/orders/${t.id}/invoice.pdf?paper=thermal80&token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",className:"btn-secondary px-3 py-1 text-xs",children:"PDF حراري 80mm"}),e.jsx("a",{href:`/api/orders/${t.id}/invoice?paper=thermal80&auto=1&token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",className:"btn-primary px-3 py-1 text-xs",children:"طباعة حرارية الآن"})]}),n&&e.jsxs("div",{className:"mt-3 p-3 border rounded bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"عنوان الشحن"}),e.jsx("button",{type:"button",onClick:()=>{try{navigator.clipboard.writeText(S)}catch{}},className:"text-xs text-blue-700 hover:underline",children:"نسخ"})]}),e.jsxs("div",{className:"text-sm leading-relaxed",children:[n.name&&e.jsx("div",{children:n.name}),n.email&&e.jsx("div",{className:"text-gray-600",children:n.email}),e.jsxs("div",{children:[n.country," ",n.city?e.jsxs(e.Fragment,{children:["- ",n.city]}):null]}),n.line1&&e.jsx("div",{children:n.line1}),n.phone&&e.jsx("div",{className:"text-gray-700",children:n.phone})]})]}),_.length>0&&e.jsxs("div",{className:"mt-3 p-3 border rounded bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm font-semibold",children:"الشحنات"}),e.jsx(F,{to:`/order/${t.id}/track`,className:"text-xs text-blue-700 hover:underline",children:"فتح شاشة التتبع"})]}),e.jsx("ul",{className:"text-xs space-y-1",children:_.map((a,s)=>e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"inline-flex items-center gap-1",children:e.jsx("span",{className:"px-1.5 py-0.5 rounded bg-gray-100 border text-gray-700",children:a.provider||"provider"})}),e.jsxs("span",{children:["رقم التتبع: ",e.jsx("strong",{children:a.trackingNumber||a.trackingId||"—"})]}),a.trackingUrl&&e.jsx("a",{href:a.trackingUrl,target:"_blank",rel:"noopener",className:"text-primary-red underline",children:"تتبّع خارجي"}),e.jsx("span",{className:"ml-auto opacity-70",children:a.status||"—"})]},a.id||s))})]}),e.jsxs("div",{className:"mt-4 p-3 border rounded bg-gray-50 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:"التحويل البنكي"}),t.paymentMethod!=="bank"&&t.status==="pending"&&e.jsx("button",{type:"button",onClick:k,className:"btn-secondary px-3 py-1 text-xs",children:"بدء التحويل"})]}),t.paymentMethod!=="bank"&&t.status!=="pending"&&t.status!=="pending_bank_review"&&e.jsxs("div",{className:"text-xs text-amber-700 bg-amber-50 border border-amber-200 p-2 rounded",children:["لا يمكن رفع إيصال الآن. الحالة الحالية: ",e.jsx("strong",{children:t.status}),". الرفع متاح فقط عندما تكون الحالة (pending) لتبدأ التحويل أو (pending_bank_review) بعد البدء."]}),(t.paymentMethod==="bank"||t.status==="pending_bank_review")&&e.jsxs(e.Fragment,{children:[t.paymentMeta?.bank?.reference&&e.jsxs("div",{className:"text-xs",children:["الرقم المرجعي: ",e.jsx("span",{className:"font-mono",children:t.paymentMeta.bank.reference})]}),e.jsx("div",{className:"text-xs text-gray-600 leading-relaxed",children:t.paymentMeta?.bank?.receiptUrl?"تم رفع الإيصال، بانتظار المراجعة.":"قم برفع إيصال التحويل البنكي (صورة أو PDF حتى 5MB) ليتم مراجعته."}),e.jsxs("div",{className:"flex items-center gap-3 flex-wrap text-xs",children:[t.paymentMeta?.bank?.receiptUrl?e.jsxs(e.Fragment,{children:[e.jsx("a",{href:t.paymentMeta.bank.receiptUrl,target:"_blank",rel:"noopener",className:"text-blue-600 underline",children:"عرض الإيصال"}),!b&&e.jsx("button",{type:"button",onClick:()=>f(!0),className:"btn-secondary px-2 py-1",children:"استبدال الإيصال"}),b&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("input",{type:"file",accept:"image/*,.pdf",disabled:d,onChange:N}),e.jsx("button",{type:"button",onClick:()=>f(!1),className:"text-gray-500 hover:text-gray-700",children:"إلغاء"})]})]}):e.jsx("input",{type:"file",accept:"image/*,.pdf",disabled:d,onChange:N}),d&&e.jsx("span",{className:"opacity-70",children:"جاري الرفع..."}),g&&e.jsxs("span",{className:"text-red-600",children:["فشل: ",g]})]})]})]})]}),e.jsx("div",{className:"mb-6 space-y-3",children:(t.items||[]).map(a=>{const s=typeof a.name=="string"?a.name:a.name?.ar||a.name?.en||a.productId;return e.jsxs("div",{className:"flex items-center gap-4 p-3 border rounded",children:[a.image&&e.jsx("img",{src:a.image,alt:s,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold",children:s}),e.jsxs("div",{className:"text-sm text-gray-600",children:[a.price," ر.س × ",a.quantity||1]})]}),e.jsxs("div",{className:"font-bold",children:[(a.price*(a.quantity||1)).toFixed(2)," ر.س"]})]},a.id)})}),e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsx("div",{children:h?.role==="admin"&&e.jsxs("select",{value:t.status,onChange:async a=>{u(!0),await w(t.id,a.target.value),u(!1)},children:[e.jsx("option",{value:"pending",children:"قيد الانتظار"}),e.jsx("option",{value:"pending_bank_review",children:"مراجعة تحويل بنكي"}),e.jsx("option",{value:"processing",children:"قيد المعالجة"}),e.jsx("option",{value:"shipped",children:"تم الشحن"}),e.jsx("option",{value:"delivered",children:"تم التوصيل"}),e.jsx("option",{value:"cancelled",children:"ملغي"})]})}),e.jsxs("div",{className:"ml-auto flex items-center gap-4",children:[h?.role==="admin"&&e.jsx("button",{className:"btn-secondary",disabled:j,onClick:async()=>{v(!0);try{const s=await(await C(async()=>{const{default:r}=await import("./index-KQCI4LeS.js").then(m=>m.F);return{default:r}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]))).default.whatsappSendInvoiceByOrder(t.id);if(s?.ok)alert("تم إرسال رابط الفاتورة عبر واتساب");else{const r=s?.reason||s?.error||"غير معروف";alert("تعذر الإرسال عبر واتساب: "+r)}}catch(a){alert("فشل الإرسال عبر واتساب: "+(a?.message||"خطأ"))}finally{v(!1)}},children:j?"يرسل...":"إرسال الفاتورة عبر واتساب"}),t.status==="paid"&&e.jsx("button",{className:"btn-secondary",onClick:async()=>{try{await D(t.id,{format:"a4"})}catch(a){alert("تعذر فتح الفاتورة: "+(a?.message||"خطأ"))}},children:"تحميل الفاتورة (الجديدة)"}),e.jsx("button",{className:"btn-secondary",onClick:()=>window.open(E(t.id)+`?token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,"_blank"),children:"عرض الفاتورة"}),e.jsx("a",{className:"btn-secondary",href:`/api/orders/${t.id}/invoice.pdf?token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",children:"PDF A4"}),e.jsx("a",{className:"btn-secondary",href:`/api/orders/${t.id}/invoice.pdf?paper=thermal80&token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,target:"_blank",rel:"noopener",children:"PDF حراري 80mm"}),e.jsx("button",{className:"btn-primary",onClick:()=>window.open(`/api/orders/${t.id}/invoice?paper=thermal80&auto=1&token=${encodeURIComponent(localStorage.getItem("my_store_token")||"")}`,"_blank"),children:"طباعة حرارية"}),e.jsxs("div",{className:"text-lg font-bold",children:["الإجمالي: ",$," ر.س"]})]})]})]})};export{ee as default};
