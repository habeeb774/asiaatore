const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-KQCI4LeS.js","assets/vendor.react-BYd2qOD7.js","assets/vendor-B1AZ7KNd.js","assets/vendor.router-BdFOcp8q.js","assets/vendor.i18next-COqwnjR1.js","assets/vendor.zustand-BuMo4m-J.js","assets/vendor.tanstack-K6OTystZ.js","assets/vendor.leaflet-DeoKySpZ.js","assets/index-DZaiRlRO.css","assets/vendor-B1-rhOTE.css"])))=>i.map(i=>d[i]);
import{r as i,j as t}from"./vendor.react-BYd2qOD7.js";import{_ as v}from"./vendor.tanstack-K6OTystZ.js";import{e as H,f as J,p as K,t as Q,v as x}from"./index-KQCI4LeS.js";import{M as Y}from"./Modal-B0gOZ9wp.js";import"./vendor-B1AZ7KNd.js";import"./vendor.router-BdFOcp8q.js";import"./vendor.i18next-COqwnjR1.js";import"./vendor.zustand-BuMo4m-J.js";import"./vendor.leaflet-DeoKySpZ.js";/* empty css                     */const D=["pending","paid","shipped","completed","cancelled"],Z=({o:n,updateOrderStatus:g,onDeleteRequest:S,checked:k,onToggle:b})=>t.jsxs("div",{style:{padding:"10px 12px",border:"1px solid #e5e7eb",borderRadius:12,background:"#fff",display:"grid",gap:6},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("input",{type:"checkbox",checked:!!k,onChange:()=>b&&b(n.id)}),t.jsxs("strong",{style:{fontSize:".8rem"},children:["طلب #",n.id]})]}),t.jsx("span",{style:{fontSize:".6rem",background:"#f1f5f9",padding:"4px 8px",borderRadius:20},children:n.status})]}),t.jsxs("div",{style:{fontSize:".65rem",color:"#475569",display:"flex",gap:12,flexWrap:"wrap"},children:[t.jsxs("span",{children:["العميل: ",n.customer?.name||n.customer?.fullName||"غير محدد"]}),t.jsxs("span",{children:["الإجمالي: ",n.totals?.grandTotal||0," ر.س"]}),t.jsxs("span",{children:["العناصر: ",n.items?.length||0]})]}),t.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:6},children:[t.jsx("select",{value:n.status,onChange:c=>g&&g(n.id,c.target.value),style:{padding:"4px 8px",border:"1px solid #d1d5db",borderRadius:8,fontSize:".6rem"},children:D.map(c=>t.jsx("option",{value:c,children:c},c))}),t.jsx("a",{href:`/api/orders/${n.id}/invoice`,target:"_blank",rel:"noopener",style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#fff",fontSize:12,textDecoration:"none"},children:"فاتورة"}),t.jsx("button",{type:"button",onClick:()=>S&&S(n.id),style:{background:"#dc2626",color:"#fff",border:0,borderRadius:8,padding:"4px 10px",fontSize:".6rem",cursor:"pointer"},children:"حذف"})]})]}),ee=()=>{const{user:n}=H()||{},{orders:g=[],updateOrderStatus:S,mergeOrder:k,refresh:b,loading:c}=J()||{},{deleteOrder:P}=K()||{},r=Q?.()||null,[p,U]=i.useState("all"),[C,M]=i.useState(""),[u,h]=i.useState([]),[R,V]=i.useState("paid"),[w,B]=i.useState(""),[G,W]=i.useState([]),[y,_]=i.useState(!1),[A,X]=i.useState(""),[O,$]=i.useState(""),[d,j]=i.useState(1),E=8,[F,L]=i.useState(!1),[m,q]=i.useState({title:"",message:"",onConfirm:null,confirmLabel:"نعم",cancelLabel:"إلغاء"}),N=({title:e,message:s,onConfirm:a,confirmLabel:l,cancelLabel:o})=>{q({title:e||"",message:s||"",onConfirm:a||null,confirmLabel:l||"نعم",cancelLabel:o}),L(!0)},z=(p==="all"?g:g.filter(e=>e.status===p)).filter(e=>{if(!C.trim())return!0;const s=C.trim().toLowerCase();return(e.id+"").includes(s)||(e.customer?.name||"").toLowerCase().includes(s)}),f=Math.max(1,Math.ceil(z.length/E)),T=z.slice((d-1)*E,d*E);return i.useEffect(()=>{d>f&&j(f)},[f,d]),i.useEffect(()=>{y&&h(T.map(e=>e.id))},[y,d,p,C]),i.useEffect(()=>{let e=!0;return(async()=>{try{const s=(()=>{try{return localStorage.getItem("my_store_token")}catch{return null}})(),a=s?{Authorization:`Bearer ${s}`}:{},l=await fetch("/api/delivery/drivers/online",{headers:a});if(!l.ok)return;const o=await l.json();if(!e)return;W(Array.isArray(o?.drivers)?o.drivers:o?.data||[])}catch{}})(),()=>{e=!1}},[]),t.jsxs("div",{style:{direction:"rtl"},"aria-busy":c?"true":"false","aria-live":"polite",children:[t.jsx("h2",{style:{margin:"0 0 1rem"},children:"إدارة الطلبات"}),!n||n.role!=="admin"?t.jsx("div",{style:{padding:"1rem",background:"#fef2f2",color:"#b91c1c",borderRadius:10,fontSize:".8rem"},children:"صلاحيات غير كافية"}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:8,marginBottom:12},children:[t.jsxs("select",{value:p,onChange:e=>{U(e.target.value),j(1)},style:{padding:6,borderRadius:8,border:"1px solid #e5e7eb",fontSize:12},children:[t.jsx("option",{value:"all",children:"جميع الحالات"}),D.map(e=>t.jsx("option",{value:e,children:e},e))]}),t.jsx("input",{value:C,onChange:e=>{M(e.target.value),j(1)},placeholder:"بحث (رقم / عميل)",style:{padding:6,borderRadius:8,border:"1px solid #e5e7eb",fontSize:12,minWidth:180}}),t.jsxs("button",{type:"button",onClick:()=>{_(e=>{const s=!e;return s||h([]),s})},title:"اختيار الكل",style:{padding:6,borderRadius:8,border:"1px solid #e5e7eb",background:y?"#efefef":"#fff"},children:[" ",y?"إلغاء الاختيار":"اختيار الكل"]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsx("select",{value:R,onChange:e=>V(e.target.value),style:{padding:6,borderRadius:8,border:"1px solid #e5e7eb"},children:D.map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsx("button",{type:"button",onClick:async()=>{if(!u.length)return r?.warn?.("اختر طلبات لتنفيذ الإجراء");N({title:"تأكيد تغيير الحالة",message:`تغيير حالة ${u.length} طلب إلى ${R}?`,confirmLabel:"تأكيد",cancelLabel:"إلغاء",onConfirm:async()=>{try{await v(()=>import("./index-KQCI4LeS.js").then(e=>e.G),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])).then(e=>e.adminApi.bulkUpdateOrdersStatus(u,R)),u.forEach(e=>k({id:e,status:R})),h([]),_(!1),r?.success?.("تم تغيير الحالة بنجاح")}catch(e){r?.error?.("فشل العملية: "+(e.message||e))}}})},style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#10b981",color:"#fff"},children:"تغيير حالة مجمّع"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsxs("select",{value:w,onChange:e=>B(e.target.value),style:{padding:6,borderRadius:8,border:"1px solid #e5e7eb"},children:[t.jsx("option",{value:"",children:"اختر سائقاً"}),G.map(e=>t.jsx("option",{value:e.userId||e.id,children:e.name||e.fullName||e.email||"driver:"+(e.userId||e.id)},e.userId||e.id))]}),t.jsx("button",{type:"button",onClick:async()=>{if(!u.length)return r?.warn?.("اختر طلبات للإسناد");if(!w)return r?.warn?.("اختر سائقاً لإتمام الإسناد");try{await v(()=>import("./index-KQCI4LeS.js").then(e=>e.G),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])).then(e=>e.adminApi.deliveryAssignBulk(u,w)),u.forEach(e=>k({id:e,deliveryDriverId:w,deliveryStatus:"assigned"})),h([]),_(!1),r?.success?.("تم إسناد الطلبات للسائق")}catch(e){r?.error?.("فشل الإسناد: "+(e.message||e))}},style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#06b6d4",color:"#fff"},children:"إسناد مجمّع"}),t.jsx("button",{type:"button",onClick:async()=>{try{const e=await v(()=>import("./index-KQCI4LeS.js").then(s=>s.G),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])).then(s=>s.adminApi.deliveryAssignAuto({limit:50}));b&&await b(),r?.success?.("تم الإسناد التلقائي")}catch(e){r?.error?.("فشل الإسناد التلقائي: "+(e.message||e))}},style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#f59e0b",color:"#fff"},children:"إسناد تلقائي"})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[t.jsxs("label",{style:{display:"flex",flexDirection:"column",fontSize:11},children:["من",t.jsx("input",{type:"date",value:A,onChange:e=>X(e.target.value),style:{padding:6,borderRadius:6,border:"1px solid #e5e7eb",fontSize:12}})]}),t.jsxs("label",{style:{display:"flex",flexDirection:"column",fontSize:11},children:["إلى",t.jsx("input",{type:"date",value:O,onChange:e=>$(e.target.value),style:{padding:6,borderRadius:6,border:"1px solid #e5e7eb",fontSize:12}})]}),t.jsx("button",{type:"button",onClick:async()=>{try{const e={status:p==="all"?void 0:p,from:A||void 0,to:O||void 0},s=await v(()=>import("./index-KQCI4LeS.js").then(I=>I.G),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])).then(I=>I.adminApi.exportOrdersCsv(e)),a=new Blob([s],{type:"text/csv;charset=utf-8"}),l=URL.createObjectURL(a),o=document.createElement("a");o.href=l,o.download="orders.csv",o.click(),URL.revokeObjectURL(l),r?.success?.("تم تنزيل CSV")}catch(e){r?.error?.("فشل التصدير: "+(e.message||e))}},style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#fff"},children:"تصدير CSV"}),t.jsx("button",{type:"button",onClick:async()=>{try{const e={status:p==="all"?void 0:p,from:A||void 0,to:O||void 0},s=await v(()=>import("./index-KQCI4LeS.js").then(o=>o.G),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])).then(o=>o.adminApi.exportOrdersXlsx(e)),a=URL.createObjectURL(s),l=document.createElement("a");l.href=a,l.download="orders.xlsx",l.click(),URL.revokeObjectURL(a),r?.success?.("تم تنزيل XLSX")}catch(e){r?.error?.("فشل التصدير: "+(e.message||e))}},style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#fff"},children:"تصدير XLSX"})]}),t.jsxs("div",{style:{fontSize:12,alignSelf:"center"},children:["عدد: ",z.length]})]}),c?t.jsx("div",{style:{display:"grid",gap:10},children:Array.from({length:6}).map((e,s)=>t.jsx("div",{style:{padding:"10px 12px",border:"1px solid #e5e7eb",borderRadius:12,background:"#fff"},children:t.jsxs("div",{style:{display:"grid",gap:8},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(x,{className:"h-4 w-24"}),t.jsx(x,{className:"h-4 w-16"})]}),t.jsxs("div",{style:{display:"flex",gap:12},children:[t.jsx(x,{className:"h-3 w-40"}),t.jsx(x,{className:"h-3 w-24"}),t.jsx(x,{className:"h-3 w-20"})]}),t.jsxs("div",{style:{display:"flex",gap:6},children:[t.jsx(x,{className:"h-7 w-24"}),t.jsx(x,{className:"h-7 w-16"}),t.jsx(x,{className:"h-7 w-16"})]})]})},s))}):t.jsx("div",{style:{display:"grid",gap:10},children:z.length===0?t.jsx("div",{style:{fontSize:13,color:"#64748b"},children:"لا توجد طلبات مطابقة."}):T.map(e=>t.jsx(Z,{o:e,updateOrderStatus:S,onDeleteRequest:s=>N({title:"حذف الطلب",message:`هل أنت متأكد من حذف الطلب #${s}? هذا الإجراء لا يمكن التراجع عنه.`,confirmLabel:"احذف",cancelLabel:"إلغاء",onConfirm:async()=>{try{await P(s),b&&await b(),r?.success?.("تم حذف الطلب")}catch(a){r?.error?.("فشل الحذف: "+(a?.message||a))}}}),checked:u.includes(e.id),onToggle:s=>{h(a=>a.includes(s)?a.filter(l=>l!==s):[...a,s]),y&&_(!1)}},e.id))}),f>1&&t.jsxs("div",{style:{display:"flex",gap:6,marginTop:16,flexWrap:"wrap"},children:[t.jsx("button",{disabled:d===1,onClick:()=>j(e=>Math.max(1,e-1)),style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#fff",fontSize:12,cursor:d===1?"not-allowed":"pointer"},children:"السابق"}),t.jsxs("span",{style:{fontSize:12,alignSelf:"center"},children:["صفحة ",d," / ",f]}),t.jsx("button",{disabled:d===f,onClick:()=>j(e=>Math.min(f,e+1)),style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#fff",fontSize:12,cursor:d===f?"not-allowed":"pointer"},children:"التالي"})]}),t.jsx(Y,{open:F,onClose:()=>L(!1),title:m.title,size:"sm",footer:t.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[t.jsx("button",{onClick:()=>L(!1),style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#fff"},children:m.cancelLabel||"إلغاء"}),t.jsx("button",{onClick:async()=>{try{L(!1),await(m.onConfirm?m.onConfirm():null)}catch(e){r?.error?.(e?.message||"حدث خطأ")}},style:{padding:"6px 10px",borderRadius:8,border:"1px solid #e5e7eb",background:"#ef4444",color:"#fff"},children:m.confirmLabel||"نعم"})]}),children:t.jsx("div",{style:{fontSize:13},children:m.message})})]})]})};function pe(){return t.jsx(ee,{})}export{pe as default};
